---
source: crates/bitnet-kernels/tests/opencl_snapshot_tests.rs
expression: MATMUL_I2S_SRC
---
/// Matrix multiplication for I2S (2-bit signed) quantized weights.
///
/// Computes C = A * B where:
///   A is an [M x K] matrix of int8 activations
///   B is a [K x N] matrix of uint8 packed 2-bit weights (4 values per byte)
///   C is an [M x N] matrix of float32 results
///
/// Each byte in B contains 4 2-bit signed values packed as:
///   bits [1:0] = value 0, bits [3:2] = value 1, etc.
/// Values are in {-1, 0, 1} encoded as: 0b00=0, 0b01=1, 0b11=-1 (0b10 unused)

__kernel void matmul_i2s(
    __global const char* A,       // [M x K] int8 activations
    __global const uchar* B,      // [K/4 x N] packed 2-bit weights
    __global float* C,            // [M x N] output
    const uint M,
    const uint N,
    const uint K
) {
    const uint row = get_global_id(0);  // M dimension
    const uint col = get_global_id(1);  // N dimension

    if (row >= M || col >= N) return;

    float sum = 0.0f;
    const uint k_packed = K / 4;  // 4 values per byte

    for (uint kp = 0; kp < k_packed; kp++) {
        uchar packed = B[kp * N + col];

        // Unpack 4 x 2-bit signed values from byte
        // Encoding: 0b00=0, 0b01=+1, 0b11=-1
        for (uint sub = 0; sub < 4; sub++) {
            uint k_idx = kp * 4 + sub;
            if (k_idx >= K) break;

            uchar bits = (packed >> (sub * 2)) & 0x03;
            int w;
            if (bits == 0x01) w = 1;
            else if (bits == 0x03) w = -1;
            else w = 0;  // 0b00 = 0, 0b10 treated as 0

            char a_val = A[row * K + k_idx];
            sum += (float)a_val * (float)w;
        }
    }

    C[row * N + col] = sum;
}
