---
source: crates/bitnet-kernels/tests/opencl_snapshot_tests.rs
expression: QUANTIZE_I2S_SRC
---
/// Quantize float32 activations to int8 using per-group absmax scaling.
///
/// For each group of `group_size` elements:
///   1. Find the absolute maximum value
///   2. Compute scale = absmax / 127.0
///   3. Quantize each element: output[i] = round(input[i] / scale)
///   4. Clamp to [-127, 127]

__kernel void quantize_i2s(
    __global const float* input,    // [N] float32 input
    __global uchar* output,         // [N/4] packed 2-bit output
    __global float* scales,         // [N/group_size] per-group scales
    const uint N,
    const uint group_size
) {
    const uint group_id = get_global_id(0);
    const uint num_groups = (N + group_size - 1) / group_size;

    if (group_id >= num_groups) return;

    const uint start = group_id * group_size;
    const uint end = min(start + group_size, N);

    // Step 1: Find absmax in this group
    float absmax = 0.0f;
    for (uint i = start; i < end; i++) {
        float val = fabs(input[i]);
        absmax = fmax(absmax, val);
    }

    // Step 2: Compute scale
    float scale = absmax > 0.0f ? absmax : 1.0f;
    scales[group_id] = scale;

    // Step 3: Quantize to ternary {-1, 0, +1} and pack
    // Pack 4 ternary values per byte
    const uint pack_start = start / 4;

    for (uint i = start; i < end; i += 4) {
        uchar packed = 0;
        for (uint sub = 0; sub < 4 && (i + sub) < end; sub++) {
            float normalized = input[i + sub] / scale;
            int ternary;
            if (normalized > 0.5f) ternary = 1;       // 0b01
            else if (normalized < -0.5f) ternary = 3;  // 0b11 = -1
            else ternary = 0;                           // 0b00

            packed |= (uchar)(ternary & 0x03) << (sub * 2);
        }
        output[i / 4] = packed;
    }
}
