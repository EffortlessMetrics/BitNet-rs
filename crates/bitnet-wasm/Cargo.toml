[package]
name = "bitnet-wasm"
version.workspace = true
edition.workspace = true
license.workspace = true
repository.workspace = true
homepage.workspace = true
authors.workspace = true
keywords.workspace = true
categories.workspace = true
description = "WebAssembly bindings for BitNet 1-bit LLM inference"

[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
futures-util = "0.3.31"
# getrandom for WASM compatibility
getrandom = { version = "0.3.3", features = ["wasm_js"] }
bitnet-common = { path = "../bitnet-common" }
bitnet-models = { path = "../bitnet-models" }
bitnet-quantization = { path = "../bitnet-quantization" }
bitnet-kernels = { path = "../bitnet-kernels", features = ["cpu"], optional = true }
# Keep inference optional to avoid pulling tokio/mio on wasm by default.
bitnet-inference = { path = "../bitnet-inference", optional = true, default-features = false }
bitnet-tokenizers = { path = "../bitnet-tokenizers", default-features = false }

# WebAssembly specific dependencies
wasm-bindgen = { workspace = true, features = ["serde-serialize"] }
wasm-bindgen-futures = "0.4.53"
js-sys = { workspace = true }
# Add common web APIs we'll likely use as modules are re-enabled
web-sys = { workspace = true, features = [
    "console",
    "Window",
    "Navigator",
    "Performance",
    "PerformanceTiming"
] }

# Serialization
serde = { workspace = true }
serde_json = { workspace = true }
serde-wasm-bindgen = "0.6.5"

# Error handling
anyhow = { workspace = true }
thiserror = { workspace = true }

# Async support
futures = { workspace = true }
wasm-streams = "0.4.2"

# Memory management - use dlmalloc as maintained alternative to wee_alloc
dlmalloc = { version = "0.2.11", optional = true, features = ["global"] }

# Logging for WASM
console_error_panic_hook = { version = "0.1.7", optional = true }
wasm-logger = "0.2.0"


[features]
integration-tests = []
default = ["browser"]           # builds without inference, compiles on wasm32
browser = ["dlmalloc"]
# Opt-in to enable the Rust inference engine on wasm once the runtime is ready.
# Use 'dep:' to activate the optional dependency and forward engine features.
inference = [
  "dep:bitnet-inference",
  "bitnet-inference/cpu",
  "bitnet-inference/rt-wasm",
]
nodejs = []
embedded = []
debug = ["console_error_panic_hook"]
# Gradual module re-enablement
wasm-utils = []
wasm-mem = []
wasm-kernels = ["dep:bitnet-kernels"]

[dev-dependencies]
wasm-bindgen-test = "0.3.53"
