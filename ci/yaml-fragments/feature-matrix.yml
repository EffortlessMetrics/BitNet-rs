  # Feature Matrix Testing - Curated critical feature sets
  # Gates CI - must pass for merge
  # See: SPEC-2025-006
  feature-matrix:
    name: Feature Matrix Tests (curated)
    runs-on: ubuntu-latest
    needs: test  # Run after primary tests pass
    strategy:
      fail-fast: false
      matrix:
        features:
          - cpu
          - cpu,avx2
          - cpu,fixtures
          - cpu,avx2,fixtures
          - ffi
        include:
          # GPU compilation check (no runtime tests)
          - features: gpu
            compile-only: true

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0

      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          key: feature-matrix-${{ matrix.features }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Build (${{ matrix.features }})
        run: |
          echo "::group::Build with features: ${{ matrix.features }}"
          cargo build --workspace --no-default-features --features "${{ matrix.features }}"
          echo "::endgroup::"

      - name: Run tests (${{ matrix.features }})
        if: matrix.compile-only != true
        run: |
          echo "::group::Test with features: ${{ matrix.features }}"

          # Select nextest profile based on features
          PROFILE="ci"
          if [[ "${{ matrix.features }}" == *"fixtures"* ]]; then
            PROFILE="fixtures"
          fi

          cargo nextest run --workspace \
            --no-default-features \
            --features "${{ matrix.features }}" \
            --profile "$PROFILE"
          echo "::endgroup::"

      - name: Run doctests (${{ matrix.features }})
        if: matrix.compile-only != true
        run: |
          echo "::group::Doctests with features: ${{ matrix.features }}"
          cargo test --doc --workspace \
            --no-default-features \
            --features "${{ matrix.features }}"
          echo "::endgroup::"
