# v0.10.0-rc.0 Release Summary

**Release Date:** 2025-10-17
**Status:** Release Candidate
**Theme:** CPU Parity, Pure-Rust Tokenization, Provenance Receipts

---

## Executive Summary

This release achieves **deterministic CPU parity** with Microsoft's BitNet C++ reference
implementation through a pure-Rust GGUF tokenizer with proper ByteLevel BPE handling
and comprehensive receipt-based provenance tracking.

### Key Achievements

✅ **Pure-Rust GGUF Tokenizer** – No external tokenizer files required
✅ **BPE ByteLevel Fix** – Correct `add_prefix_space=true` for GPT-2 compatibility
✅ **ID Remapping** – Proper HuggingFace→GGUF token ID translation
✅ **Receipt Provenance** – Reproducible tokenization with blob hashes and env metadata
✅ **Deterministic Inference** – Seeded runs with `BITNET_SEED` + `RAYON_NUM_THREADS=1`
✅ **Model-Aware Goldens** – Split test fixtures for GPT-2, LLaMA, LLaMA-3

---

## Major Changes

### 1. Pure-Rust GGUF Tokenizer (`bitnet-tokenizers`)

**Problem:** Previous implementation relied on external tokenizer files or had ByteLevel BPE mismatches causing first-token parity failures.

**Solution:**

- Load tokenizers directly from GGUF metadata (SPM protobuf, BPE vocab+merges)
- BPE with `add_prefix_space=true` on both pre-tokenizer **and** decoder
- Piece-to-GGUF-ID remapping: `HashMap<String, u32>` for authoritative token IDs
- SPM blob SHA256 hashing for reproducibility

**Impact:**

- First token now matches C++ reference: `3923` (" What") instead of `3639` ("What")
- Tokenization is deterministic and reproducible across runs
- Self-contained models – no external tokenizer.json needed

**Files:**

- `crates/bitnet-tokenizers/src/gguf_loader.rs` (lines 231-320, 369-409)

### 2. Receipt-Based Provenance (`crossval`)

**Problem:** Insufficient metadata to debug parity failures or reproduce inference.

**Solution:**

- Tokenizer metadata: `merges_count`, `tokenizer_blob_sha256`
- Environment metadata: `target_cpu`, `cpu_features`, `libc`, `rayon_threads`, `deterministic`, `seed`
- C++ metadata: `llama_cpp_commit` (from `BITNET_CPP_DIR/.git`)
- Prompt hash: `blake3` for formatted prompt verification

**Impact:**

- Full provenance chain from prompt → tokens → logits → generation
- Receipts are durable GitHub artifacts for CI/CD
- Timeout receipts provide diagnostic data even on hangs

**Files:**

- `crossval/tests/parity_bitnetcpp.rs` (lines 204-252, 477-523, 794-836)

### 3. Model-Aware Golden Token Tests (`bitnet-tokenizers`)

**Problem:** Unified golden tokens mixed GPT-2 and LLaMA expectations, causing false failures.

**Solution:**

- Split fixtures: `golden_tokens_gpt2.json`, `golden_tokens_llama.json`, `golden_tokens_llama3.json`
- Auto-select based on `tokenizer.ggml.model` from GGUF metadata
- LLaMA-3 chat support with special tokens (`<|start_header_id|>`, `<|eot_id|>`)

**Impact:**

- Exact-match validation for each tokenizer family
- Prevents future drift in BPE or SPM implementations
- Chat template parity locked in

**Files:**

- `crates/bitnet-tokenizers/tests/golden_tokens_{gpt2,llama,llama3}.json`
- `crates/bitnet-tokenizers/tests/golden_tokens_test.rs` (lines 34-117, 148-228)

### 4. Optional Debug Diagnostics (`tok-debug` feature)

**Problem:** Hard to diagnose piece→ID mismatches when parity fails.

**Solution:**

- Feature-gated diagnostics: `--features tok-debug`
- Dumps first 8 tokens: `hf_id`, `piece`, `gguf_id`

**Usage:**

```bash
cargo test -p crossval --features tok-debug,crossval,spm parity_bitnetcpp -- --nocapture
```

**Output:**

```text
tok-debug: BPE encoding 6 HF tokens
tok-debug: token[0]: hf_id=3923 piece=' What' gguf_id=3923
tok-debug: token[1]: hf_id=318 piece=' is' gguf_id=318
...
```

**Files:**

- `crates/bitnet-tokenizers/src/gguf_loader.rs` (lines 383-408)
- `crates/bitnet-tokenizers/Cargo.toml` (line 42)

### 5. LLaMA-3 Chat Prompt Support (`crossval`)

**Problem:** Parity tests only validated math prompts, not chat templates.

**Solution:**

- Multi-prompt support via `CROSSVAL_PROMPT_SET=math|chat|all`
- Auto-detect `parse_special=true` for prompts with `<|start_header_id|>` or `<|eot_id|>`
- Proper EOT vs EOS handling

**Usage:**

```bash
CROSSVAL_PROMPT_SET=chat cargo test -p crossval --features crossval,spm parity_bitnetcpp
```

**Files:**

- `crossval/tests/parity_bitnetcpp.rs` (lines 353-368, 634-638)

---

## CI Integration

### New Workflows

1. **`parity-proof.yml`** – Fast PR gate (< 15 min)
   - Rust-only parity validation
   - Receipt artifact upload
   - Status verification (must be `ok` or `rust_only`)

2. **`nightly-parity-matrix.yml`** – Comprehensive nightly testing
   - Prompt matrix: `math`, `chat`
   - Quantization matrix: `i2_s` (TL1/TL2 to be added)
   - Dated receipt archiving

### Example Receipts

**Green receipt** (Rust-only):

```json
{
  "parity": {
    "status": "rust_only",
    "cpp_available": false
  },
  "tokenizer": {
    "source": "rust",
    "kind": "gpt2",
    "merges_count": 50257,
    "tokenizer_blob_sha256": null
  },
  "rust": {
    "decoded_tokens": [3923, 318, 362, 10, 17, 30]
  },
  "environment": {
    "deterministic": "1",
    "seed": "42",
    "rayon_threads": "1"
  }
}
```

**Green receipt** (with C++ parity):

```json
{
  "parity": {
    "status": "ok",
    "cpp_available": true,
    "cosine_similarity": 0.999987,
    "exact_match_rate": 1.0,
    "first_divergence_step": null
  },
  "tokenization": {
    "tokens_match": true
  }
}
```

---

## Migration Guide

### For Existing Users

1. **No breaking changes** – Pure-Rust tokenizer is a drop-in replacement
2. **Explicit features** – Always specify `--features spm` for LLaMA models
3. **Deterministic runs** – Add env vars for reproducibility:

   ```bash
   export BITNET_DETERMINISTIC=1
   export BITNET_SEED=42
   export RAYON_NUM_THREADS=1
   ```

### For CI/CD Pipelines

1. **Enable parity checks** – Add `parity-proof.yml` to required checks
2. **Archive receipts** – Store dated receipts as artifacts
3. **Nightly validation** – Schedule `nightly-parity-matrix.yml`

---

## Testing

### Verification Commands

```bash
# 1. Verify golden tokens load
cargo test -p bitnet-tokenizers --features spm --test golden_tokens_test

# 2. Run Rust-only parity (no C++ required)
export CROSSVAL_GGUF=/path/to/model.gguf
export RAYON_NUM_THREADS=1 BITNET_DETERMINISTIC=1 BITNET_SEED=42
cargo test -p crossval --release --features crossval,integration-tests,spm parity_bitnetcpp

# 3. Inspect receipt
jq '{status,tokenizer_source,exact_match_rate}' docs/baselines/$(date +%F)/parity-bitnetcpp.json

# 4. FFI lifecycle (if ffi feature enabled)
cargo test -p bitnet-sys --release --features ffi context_lifecycle_100x
```

### Expected Green Signals

- ✅ `status: "ok"` or `"rust_only"` in receipt
- ✅ `tokenizer_source: "rust"`
- ✅ `exact_match_rate: 1.0` (when C++ available)
- ✅ `first_divergence_step: null`
- ✅ Golden token tests pass for all families (gpt2, llama, llama3)

---

## Known Issues & Limitations

### Current Scope

- **CPU-only parity** – GPU parity validation is future work
- **Single prompt per run** – Multi-prompt iteration not yet implemented
- **I2_S quantization** – TL1/TL2 parity not yet validated

### Non-Issues (Intentional Design)

- **Rust-only default** – C++ parity requires `BITNET_CPP_DIR` (optional)
- **120s timeout** – Prevents CI hangs; writes diagnostic receipt on timeout
- **Feature-gated tok-debug** – Zero overhead when not enabled

---

## Performance

### Parity Test Metrics (Release Mode)

- **Tokenization**: < 10ms (6 tokens)
- **Prefill logits**: ~500ms (2B model, 6 tokens)
- **4-step greedy decode**: ~2s (2B model)
- **Total parity run**: < 10s (well under 120s timeout)

### Receipt Size

- ~2-3 KB per receipt (JSON, pretty-printed)
- Minimal storage impact for nightly archives

---

## Credits

This release incorporates fixes for:

- BPE ByteLevel `add_prefix_space` (Issue #468)
- First-token parity mismatch (GPT-2 tokenization)
- SPM blob reproducibility (SHA256 fingerprinting)
- Deterministic seeded runs (RAYON + seed control)

---

## Next Steps (v0.10.0 Final)

1. ✅ Parity proof receipt: `tokenizer_source:"rust"`, `status:"ok"`
2. ✅ First-token ID: **3923** for " What"
3. ✅ Chat prompt passes (EOT/EOS + tie-break)
4. ✅ Golden tokens split by model family
5. ⏳ CI workflows live (after merge)
6. ⏳ README/CHANGELOG updated (see below)
7. ⏳ RC tag: `v0.10.0-rc.0`

**Go/No-Go:** All green when parity receipt shows `status:"ok"` or `"rust_only"` with exact-match tokenization.
