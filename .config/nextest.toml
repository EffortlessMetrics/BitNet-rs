# cargo-nextest configuration
# https://nexte.st/book/configuration

[profile.default]
# Test execution settings
fail-fast = { enabled = true, count = 10 }
test-threads = "num-cpus"
retries = 1

# Output settings
failure-output = "immediate"
success-output = "never"
status-level = "pass"

# Slow test detection
slow-timeout = { period = "60s", terminate-after = 3 }

# Integration binaries often need single-threaded harnesses.
[[profile.default.overrides]]
filter = 'test(binary = "integration_tests")'
test-threads = 1

# Optional: make streaming/inference tests more generous.
[[profile.default.overrides]]
filter = 'test(binary = "engine_inspect" or binary = "batch_prefill")'
slow-timeout = { period = "120s", terminate-after = 2 }

# Example CPU-heavy bins: cap harness threads if they contend.
[[profile.default.overrides]]
filter = 'package("bitnet-quantization")'
test-threads = "num-cpus"

[profile.default-miri]
slow-timeout = "10m"

[profile.ci]
# CI-specific settings
fail-fast = false
test-threads = 4
retries = { backoff = "exponential", count = 2, delay = "1s", max-delay = "10s" }

# Output for CI
failure-output = "immediate"
success-output = "final"
status-level = "fail"

# JUnit output for CI reporting
[profile.ci.junit]
path = "target/nextest/ci/junit.xml"