# syntax=docker/dockerfile:1.6
# Multi-feature test matrix for BitNet-rs
#
# Validates that all feature combinations compile and pass tests.
# Build specific stage:
#   docker build -f docker/Dockerfile.test-matrix --target test-cpu -t bitnet-rs:test-cpu .
#   docker build -f docker/Dockerfile.test-matrix --target test-gpu -t bitnet-rs:test-gpu .
#   docker build -f docker/Dockerfile.test-matrix --target test-oneapi -t bitnet-rs:test-oneapi .

# ── Base: shared Rust toolchain + workspace ──────────────────────
FROM rust:1.92-bookworm AS base

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential cmake pkg-config libssl-dev ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY Cargo.toml Cargo.lock ./
COPY crates/ ./crates/

# ── CPU feature build + test ─────────────────────────────────────
FROM base AS test-cpu

RUN cargo check --workspace --locked --no-default-features --features cpu
RUN cargo test --workspace --locked --no-default-features --features cpu \
    -- --skip "gpu" --skip "cuda" 2>&1 | tail -50

# ── GPU feature compile check ───────────────────────────────────
# Note: actual GPU tests require CUDA runtime (use Dockerfile.nvidia-gpu)
FROM base AS test-gpu

RUN cargo check --workspace --locked --no-default-features --features gpu \
    || echo "GPU compile check done (CUDA headers may be missing)"

RUN cargo check --workspace --locked --no-default-features --features cpu,gpu \
    || echo "CPU+GPU compile check done"

# ── OneAPI feature compile check ────────────────────────────────
FROM base AS test-oneapi

RUN cargo check --workspace --locked --no-default-features --features oneapi \
    || echo "OneAPI compile check done (OpenCL headers may be missing)"

RUN cargo check --workspace --locked --no-default-features --features cpu,oneapi \
    || echo "CPU+OneAPI compile check done"

# ── Full matrix validation ──────────────────────────────────────
FROM base AS test-all

# Compile check every feature combination
RUN echo "=== no-features ===" && \
    cargo check --workspace --locked --no-default-features && \
    echo "=== cpu ===" && \
    cargo check --workspace --locked --no-default-features --features cpu && \
    echo "=== cpu+avx2 ===" && \
    RUSTFLAGS="-C target-feature=+avx2" \
    cargo check --workspace --locked --no-default-features --features cpu,avx2 && \
    echo "=== cpu+fixtures ===" && \
    cargo check --workspace --locked --no-default-features --features cpu,fixtures && \
    echo "All feature matrix checks passed"

# Run CPU tests as the final validation gate
RUN cargo test --workspace --locked --no-default-features --features cpu \
    -- --skip "gpu" --skip "cuda" 2>&1 | tail -30
