From: Assistant <assistant@bitnet.rs>
Date: Sun, 26 Oct 2025 00:00:00 +0000
Subject: [PATCH] feat(xtask): implement file locking and network retry for setup-cpp-auto (AC7-AC8)

Implements file locking and network retry mechanisms for setup-cpp-auto command:

AC7: File lock prevents concurrent builds
- RAII FileLock struct with acquire() and Drop impl
- Lock file: `.{backend}.lock` in parent directory
- 60-second timeout with clear error messaging
- Automatic stale lock cleanup (>1 hour old)
- Uses fs2::FileExt for cross-platform compatibility

AC8: Network retry with exponential backoff
- Max 3 retry attempts for git clone operations
- Exponential backoff delays: 1s, 2s, 4s
- Cleanup partial clones before retry
- Only retries on network/git failures

Changes:
- Add Duration, Instant, SystemTime imports
- Add fs2::FileExt import (dependency already in Cargo.toml)
- Add FileLock struct with platform-agnostic locking
- Add clone_repository_with_retry() function
- Update install_or_update_backend() to use lock and retry

Test coverage:
- test_ac7_file_lock_prevents_concurrent_builds
- test_ac7_lock_released_on_drop
- test_ac8_network_retry_exponential_backoff
- test_ac8_network_retry_max_attempts

Specification: docs/specs/llama-cpp-auto-setup.md (AC7-AC8)
Tests: xtask/tests/llama_cpp_auto_setup_tests.rs
Documentation: docs/development/file-lock-network-retry-implementation.md

---
 xtask/src/cpp_setup_auto.rs | 150 +++++++++++++++++++++++++++++++++++-
 1 file changed, 148 insertions(+), 2 deletions(-)

