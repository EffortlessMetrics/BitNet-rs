# Example GitHub Actions workflow for BitNet-rs performance regression testing
# Place this in .github/workflows/performance.yml

name: Performance Regression Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  cpu-benchmarks:
    name: CPU Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: 1.90.0
        profile: minimal
        override: true
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run CPU quantization benchmarks
      run: |
        cargo bench -p bitnet-quantization \
          --no-default-features \
          --features cpu \
          -- --output-format json \
          | tee cpu_quantization_results.json

    - name: Check for performance regressions
      run: |
        cargo run -p xtask -- bench-compare \
          --current cpu_quantization_results.json \
          --category quantization \
          --device cpu \
          --ci \
          --format junit \
          --output junit-cpu-results.xml \
          --fail-on-regression

    - name: Generate human-readable report
      if: always()
      run: |
        cargo run -p xtask -- bench-compare \
          --current cpu_quantization_results.json \
          --category quantization \
          --device cpu \
          --ci \
          --format markdown \
          --output cpu-performance-report.md \
          --verbose

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cpu-benchmark-results
        path: |
          cpu_quantization_results.json
          junit-cpu-results.xml
          cpu-performance-report.md

    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: junit-cpu-results.xml
        comment_mode: create new
        check_name: "CPU Performance Tests"

  gpu-benchmarks:
    name: GPU Performance Benchmarks
    runs-on: ubuntu-latest
    # Note: This would typically require a self-hosted runner with GPU
    # For public repos, you might skip GPU tests or use mock scenarios

    if: false  # Disabled for demo - enable when GPU runners available

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: 1.90.0
        profile: minimal
        override: true

    - name: Setup CUDA
      uses: Jimver/cuda-toolkit@v0.2.16
      with:
        cuda: '12.1'

    - name: Run GPU quantization benchmarks
      run: |
        cargo bench -p bitnet-quantization \
          --no-default-features \
          --features gpu \
          -- --output-format json \
          | tee gpu_quantization_results.json

    - name: Check for GPU performance regressions
      run: |
        cargo run -p xtask -- bench-compare \
          --current gpu_quantization_results.json \
          --category quantization \
          --device gpu \
          --ci \
          --format junit \
          --output junit-gpu-results.xml \
          --fail-on-regression

  baseline-update:
    name: Update Performance Baselines
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [cpu-benchmarks]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: 1.90.0
        profile: minimal
        override: true

    - name: Download benchmark results
      uses: actions/download-artifact@v4
      with:
        name: cpu-benchmark-results

    - name: Update baseline (if manually triggered)
      if: contains(github.event.head_commit.message, '[update-baseline]')
      run: |
        # This would be run manually when baseline updates are needed
        cargo run -p xtask -- bench-compare \
          --current cpu_quantization_results.json \
          --format json \
          --output benchmarks/baseline/cpu/quantization/i2s_baseline.json

        # Commit the updated baseline
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add benchmarks/baseline/
        git commit -m "Update performance baselines [automated]" || exit 0
        git push

# Example for Makefile integration
performance-check:
	@echo "ðŸš€ Running performance regression check..."
	cargo bench --workspace --no-default-features --features cpu
	cargo run -p xtask -- bench-compare \
		--current target/criterion/report.json \
		--category all \
		--device cpu \
		--fail-on-regression

performance-report:
	@echo "ðŸ“Š Generating performance report..."
	cargo bench --workspace --no-default-features --features cpu
	cargo run -p xtask -- bench-compare \
		--current target/criterion/report.json \
		--category all \
		--device cpu \
		--format markdown \
		--output performance-report.md \
		--verbose
	@echo "Report saved to performance-report.md"
