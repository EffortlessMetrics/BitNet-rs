name: Parity Proof

# Run on PRs that touch inference, tokenizers, or crossval
on:
  pull_request:
    paths:
      - 'crates/bitnet-inference/**'
      - 'crates/bitnet-tokenizers/**'
      - 'crates/bitnet-sys/**'
      - 'crossval/**'
      - '.github/workflows/parity-proof.yml'

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  parity-proof:
    name: CPU Parity Proof (Release)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-parity-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-parity-

      - name: Cache BitNet.cpp build
        id: cache-bitnet-cpp
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: ${{ runner.os }}-bitnet-cpp-${{ hashFiles('xtask/src/fetch_cpp.rs') }}
          restore-keys: |
            ${{ runner.os }}-bitnet-cpp-

      - name: Fetch BitNet.cpp (if not cached)
        if: steps.cache-bitnet-cpp.outputs.cache-hit != 'true'
        run: |
          cargo run -p xtask -- fetch-cpp

      - name: Download test model
        run: |
          cargo run -p xtask -- download-model --id microsoft/bitnet-b1.58-2B-4T-gguf

      - name: Run parity test (Rust-only, release mode)
        env:
          CROSSVAL_GGUF: ${{ github.workspace }}/models/microsoft-bitnet-b1.58-2B-4T-gguf/ggml-model-i2_s.gguf
          RAYON_NUM_THREADS: 1
          BITNET_DETERMINISTIC: 1
          BITNET_SEED: 42
          BITNET_DISABLE_MINIMAL_LOADER: 1  # Fail-fast: enforce enhanced loader (no 32/0 defaults)
        run: |
          cargo test -p crossval --release \
            --no-default-features \
            --features crossval,integration-tests,spm \
            parity_bitnetcpp -- --nocapture

      - name: Inspect parity receipt
        if: always()
        run: |
          RECEIPT_PATH=$(find docs/baselines -name "parity-bitnetcpp.json" -type f | head -1)
          if [ -f "$RECEIPT_PATH" ]; then
            echo "=== Parity Receipt ==="
            jq '{
              status: .parity.status,
              tokenizer_source: .tokenizer.source,
              cosine_similarity: .parity.cosine_similarity,
              exact_match_rate: .parity.exact_match_rate,
              first_divergence_step: .parity.first_divergence_step,
              rust_decoded_tokens: .rust.decoded_tokens
            }' "$RECEIPT_PATH"
          else
            echo "No parity receipt found"
          fi

      - name: Upload parity receipt
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-receipt-${{ github.sha }}
          path: docs/baselines/**/parity-bitnetcpp.json
          if-no-files-found: warn

      - name: Verify parity status
        run: |
          RECEIPT_PATH=$(find docs/baselines -name "parity-bitnetcpp.json" -type f | head -1)
          if [ -f "$RECEIPT_PATH" ]; then
            STATUS=$(jq -r '.parity.status' "$RECEIPT_PATH")
            if [ "$STATUS" != "ok" ] && [ "$STATUS" != "rust_only" ]; then
              echo "❌ Parity check failed: status=$STATUS"
              exit 1
            fi
            echo "✅ Parity check passed: status=$STATUS"
          else
            echo "❌ No parity receipt found"
            exit 1
          fi
