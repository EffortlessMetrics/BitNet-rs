name: Parity Proof

# Run on PRs that touch inference, tokenizers, or crossval
on:
  pull_request:
    paths:
      - 'crates/bitnet-inference/**'
      - 'crates/bitnet-tokenizers/**'
      - 'crates/bitnet-sys/**'
      - 'crossval/**'
      - '.github/workflows/parity-proof.yml'

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  # Deterministic testing environment
  BITNET_DETERMINISTIC: 1
  BITNET_SEED: 42
  RAYON_NUM_THREADS: 1
  BITNET_DISABLE_MINIMAL_LOADER: 1  # AC7: Enforce enhanced loader for both flavors

jobs:
  # AC7: QK256 parity smoke (strict mode)
  # NOTE: BitNet32-F16 testing deferred until model is available in CI
  parity-smoke:
    name: Parity Smoke (QK256 Strict)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-parity-qk256-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-parity-

      - name: Cache BitNet.cpp build
        id: cache-bitnet-cpp-qk256
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: ${{ runner.os }}-bitnet-cpp-${{ hashFiles('xtask/src/fetch_cpp.rs') }}
          restore-keys: |
            ${{ runner.os }}-bitnet-cpp-

      - name: Fetch BitNet.cpp (if not cached)
        if: steps.cache-bitnet-cpp-qk256.outputs.cache-hit != 'true'
        run: |
          cargo run -p xtask -- fetch-cpp

      - name: Download QK256 test model
        run: |
          cargo run -p xtask -- download-model --id microsoft/bitnet-b1.58-2B-4T-gguf

      - name: Fetch LLaMA-3 tokenizer
        run: |
          # Try official source first if HF_TOKEN is available, otherwise use mirror
          if [ -n "${{ secrets.HF_TOKEN || '' }}" ]; then
            echo "Fetching from official source (authenticated)"
            HF_TOKEN="${{ secrets.HF_TOKEN }}" \
              cargo run -p xtask -- tokenizer \
              --into models/microsoft-bitnet-b1.58-2B-4T-gguf \
              --source official
          else
            echo "Fetching from mirror source (no authentication required)"
            cargo run -p xtask -- tokenizer \
              --into models/microsoft-bitnet-b1.58-2B-4T-gguf \
              --source mirror
          fi

      - name: Run parity smoke (QK256 strict)
        run: |
          ./scripts/parity_smoke.sh \
            models/microsoft-bitnet-b1.58-2B-4T-gguf/ggml-model-i2_s.gguf \
            models/microsoft-bitnet-b1.58-2B-4T-gguf/tokenizer.json

      - name: Verify QK256 receipt and strict loader
        if: always()
        run: |
          RECEIPT_PATH=$(find docs/baselines -name "parity-bitnetcpp.json" -type f | head -1)
          if [ -f "$RECEIPT_PATH" ]; then
            echo "=== QK256 Parity Receipt ==="
            jq '{
              status: .parity.status,
              flavor: .quant.flavor,
              cosine_similarity: .parity.cosine_similarity,
              exact_match_rate: .parity.exact_match_rate,
              cpp_available: .parity.cpp_available
            }' "$RECEIPT_PATH"

            # AC7: Verify quant.flavor == "ggml_qk256_no_scale"
            FLAVOR=$(jq -r '.quant.flavor // "unknown"' "$RECEIPT_PATH")
            if [ "$FLAVOR" != "ggml_qk256_no_scale" ]; then
              echo "❌ Expected QK256 flavor, got: $FLAVOR"
              exit 1
            fi

            # AC7: Verify parity.status in {"ok", "rust_only"}
            STATUS=$(jq -r '.parity.status' "$RECEIPT_PATH")
            if [ "$STATUS" != "ok" ] && [ "$STATUS" != "rust_only" ]; then
              echo "❌ Parity check failed: status=$STATUS"
              exit 1
            fi

            echo "✅ QK256 parity check passed: status=$STATUS, flavor=$FLAVOR"
          else
            echo "❌ No parity receipt found"
            exit 1
          fi

      - name: Validate QK256 Receipt Fields
        if: always()
        run: |
          RECEIPT_PATH=$(find docs/baselines -name "parity-bitnetcpp.json" -type f | head -1)
          if [ -f "$RECEIPT_PATH" ]; then
            # Validate quantization format and flavor
            jq -e '
              .quant.format == "I2_S" and
              .quant.flavor == "ggml_qk256_no_scale" and
              (.parity.status == "ok" or .parity.status == "rust_only")
            ' "$RECEIPT_PATH" >/dev/null || {
              echo "❌ Receipt validation failed: invalid quant fields or parity status"
              exit 1
            }
            echo "✅ Receipt fields validated: I2_S QK256 format confirmed"
          else
            echo "❌ No receipt found for validation"
            exit 1
          fi

      - name: Validate QK256 Parity Cosine (if C++ available)
        if: always()
        run: |
          RECEIPT_PATH=$(find docs/baselines -name "parity-bitnetcpp.json" -type f | head -1)
          if [ -f "$RECEIPT_PATH" ]; then
            # Check if C++ lane is available
            CPP_AVAILABLE=$(jq -r '.parity.cpp_available' "$RECEIPT_PATH")
            if [ "$CPP_AVAILABLE" = "true" ]; then
              # Verify cosine_ok is true when C++ is available
              jq -e '.parity.cosine_ok == true' "$RECEIPT_PATH" >/dev/null || {
                echo "❌ C++ parity available but cosine_ok is not true"
                exit 1
              }
              echo "✅ C++ parity validated: cosine_ok=true"
            else
              echo "ℹ️  C++ lane not available, skipping cosine validation (status: rust_only)"
            fi
          else
            echo "❌ No receipt found for cosine validation"
            exit 1
          fi

      - name: Upload QK256 receipt
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parity-receipt-qk256-${{ github.sha }}
          path: docs/baselines/**/parity-bitnetcpp.json
          if-no-files-found: warn
