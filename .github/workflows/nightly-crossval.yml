name: Nightly Cross-Validation

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      cpp_version:
        description: 'C++ implementation version to test against'
        required: false
        default: 'latest'
      extended_tests:
        description: 'Run extended test suite'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Check for upstream changes in C++ implementation
  upstream-check:
    name: Check Upstream Changes
    runs-on: ubuntu-latest
    outputs:
      cpp-version: ${{ steps.version-check.outputs.cpp-version }}
      version-changed: ${{ steps.version-check.outputs.version-changed }}
      should-run-crossval: ${{ steps.decision.outputs.should-run }}

    steps:
    - uses: actions/checkout@v4

    - name: Check current C++ version
      id: version-check
      run: |
        CURRENT_VERSION=$(cat ci/bitnet_cpp_version.txt)
        echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

        # Get latest version from upstream
        LATEST_VERSION=$(curl -s https://api.github.com/repos/microsoft/BitNet/releases/latest | jq -r .tag_name)
        echo "latest-version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "cpp-version=$LATEST_VERSION" >> $GITHUB_OUTPUT

        if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
          echo "version-changed=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Version change detected: $CURRENT_VERSION â†’ $LATEST_VERSION"
        else
          echo "version-changed=false" >> $GITHUB_OUTPUT
          echo "âœ… Version unchanged: $CURRENT_VERSION"
        fi

    - name: Decide whether to run cross-validation
      id: decision
      run: |
        # Always run on manual dispatch
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "ðŸ”§ Manual dispatch - running cross-validation"
        # Run if version changed
        elif [ "${{ steps.version-check.outputs.version-changed }}" = "true" ]; then
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Version changed - running cross-validation"
        # Run weekly (every Sunday)
        elif [ "$(date +%u)" = "7" ]; then
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "ðŸ“… Weekly run - running cross-validation"
        else
          echo "should-run=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ Skipping cross-validation (no changes, not weekly)"
        fi

  # Cross-validation test suite
  cross-validation:
    name: Cross-Validation Tests
    runs-on: ${{ matrix.os }}
    needs: upstream-check
    if: needs.upstream-check.outputs.should-run-crossval == 'true'

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            setup-cmd: sudo apt update && sudo apt install -y clang libclang-dev cmake build-essential
          - os: macos-latest
            setup-cmd: brew install cmake

    steps:
    - uses: actions/checkout@v4

    - uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-crossval-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache C++ implementation
      uses: actions/cache@v3
      with:
        path: ~/.cache/bitnet_cpp
        key: ${{ runner.os }}-cpp-${{ needs.upstream-check.outputs.cpp-version }}

    - name: Install system dependencies
      run: ${{ matrix.setup-cmd }}

    - name: Setup C++ implementation
      run: |
        # Use specific version if provided, otherwise use current
        if [ "${{ github.event.inputs.cpp_version }}" != "" ] && [ "${{ github.event.inputs.cpp_version }}" != "latest" ]; then
          export BITNET_CPP_TAG="${{ github.event.inputs.cpp_version }}"
        fi
        ./ci/fetch_bitnet_cpp.sh

    - name: Generate test fixtures
      run: cargo xtask gen-fixtures --deterministic --prompts 10

    - name: Run cross-validation tests
      run: |
        echo "ðŸ§ª Running cross-validation tests..."
        cargo test --features crossval --release -- --nocapture
      env:
        RUST_LOG: info

    - name: Run performance benchmarks
      run: |
        echo "ðŸ“Š Running performance benchmarks..."
        cargo bench --features crossval --release

    - name: Check for performance regressions
      run: |
        echo "ðŸ” Checking for performance regressions..."
        # This would analyze benchmark results and fail if regression > 5%
        if [ -f crossval/baselines.json ]; then
          echo "Baseline performance data found"
          # Add regression detection logic here
        else
          echo "No baseline data - creating initial baseline"
        fi

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results-${{ matrix.os }}
        path: |
          target/criterion/
          crossval/baselines.json
        retention-days: 30

    - name: Extended test suite
      if: github.event.inputs.extended_tests == 'true'
      run: |
        echo "ðŸ”¬ Running extended test suite..."
        cargo test --features crossval --release -- --include-ignored --test-threads=1

        # Test with different model sizes
        for fixture in crossval/fixtures/*.json; do
          echo "Testing fixture: $(basename $fixture)"
          cargo test --features crossval --release -- --exact $(basename $fixture .json)
        done

  # Performance baseline tracking
  baseline-tracking:
    name: Performance Baseline Tracking
    runs-on: ubuntu-latest
    needs: [upstream-check, cross-validation]
    if: needs.upstream-check.outputs.should-run-crossval == 'true' && always()

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download benchmark results
      uses: actions/download-artifact@v3
      with:
        name: benchmark-results-ubuntu-latest
        path: benchmark-results/

    - name: Update performance baselines
      run: |
        if [ -f benchmark-results/crossval/baselines.json ]; then
          echo "ðŸ“ˆ Updating performance baselines..."
          cp benchmark-results/crossval/baselines.json crossval/baselines.json

          # Commit updated baselines
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add crossval/baselines.json

          if git diff --staged --quiet; then
            echo "No baseline changes to commit"
          else
            git commit -m "chore: update performance baselines [skip ci]"
            git push
          fi
        fi

    - name: Create performance report
      run: |
        echo "ðŸ“Š Creating performance report..."
        cat > performance-report.md << 'EOF'
        # Nightly Cross-Validation Report

        **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **C++ Version**: ${{ needs.upstream-check.outputs.cpp-version }}
        **Trigger**: ${{ github.event_name }}

        ## Results Summary

        - âœ… Cross-validation tests: $([ -f benchmark-results/test-results.txt ] && echo "PASSED" || echo "FAILED")
        - ðŸ“Š Performance benchmarks: Completed
        - ðŸ” Regression check: $([ -f benchmark-results/regression-detected.txt ] && echo "âš ï¸ REGRESSION DETECTED" || echo "âœ… No regressions")

        ## Performance Metrics

        $(if [ -f benchmark-results/crossval/baselines.json ]; then
          echo "Current performance baselines updated."
          jq -r '"- Rust inference: \(.rust_tokens_per_second) tok/s\n- C++ inference: \(.cpp_tokens_per_second) tok/s\n- Speedup ratio: \(.speedup_ratio)x\n- Memory reduction: \(.memory_reduction * 100)%"' benchmark-results/crossval/baselines.json
        else
          echo "No performance data available."
        fi)

        ## Next Steps

        $(if [ "${{ needs.upstream-check.outputs.version-changed }}" = "true" ]; then
          echo "- ðŸ”„ C++ version updated - consider updating documentation"
          echo "- ðŸ“ Review any API changes in upstream"
        else
          echo "- âœ… No upstream changes detected"
        fi)

        ---
        *This report was generated automatically by the nightly cross-validation workflow.*
        EOF

    - name: Post results to GitHub
      if: failure() || needs.upstream-check.outputs.version-changed == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('performance-report.md', 'utf8');

          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Nightly Cross-Validation Report - ${new Date().toISOString().split('T')[0]}`,
            body: report,
            labels: ['cross-validation', 'automated', 'nightly']
          });

  # Cleanup old artifacts
  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Delete old artifacts
      uses: actions/github-script@v6
      with:
        script: |
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });

          const cutoff = new Date();
          cutoff.setDate(cutoff.getDate() - 7); // Keep artifacts for 7 days

          for (const artifact of artifacts.data.artifacts) {
            if (artifact.name.startsWith('benchmark-results-') &&
                new Date(artifact.created_at) < cutoff) {
              console.log(`Deleting old artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }
          }
