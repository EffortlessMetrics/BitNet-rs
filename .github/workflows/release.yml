name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.1.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (do not publish)'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Pre-release validation
  validate:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "Releasing version: ${VERSION}"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Invalid version format: $VERSION"
            exit 1
          fi

      - name: Install additional tools
        run: |
          cargo install cargo-audit cargo-deny

      - name: Run comprehensive quality checks
        run: |
          echo "ðŸ” Running Rust quality checks..."
          cargo fmt --all -- --check
          cargo clippy --workspace --all-targets --features cpu -- -D warnings
          cargo test --workspace --features cpu

      - name: Run security audit
        run: |
          echo "ðŸ”’ Running security audit..."
          cargo audit
          cargo deny check

      - name: Validate documentation
        run: |
          echo "ðŸ“š Validating documentation..."
          cargo doc --workspace --features cpu --no-deps --document-private-items
          # Check that README examples compile
          cargo test --doc --features cpu

      - name: Check version consistency
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          if [[ "$VERSION" != "$CARGO_VERSION" ]]; then
            echo "Version mismatch: tag=$VERSION, Cargo.toml=$CARGO_VERSION"
            exit 1
          fi

  # Cross-platform builds
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux targets
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            features: "cpu,avx2"
            cross: false
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            features: "cpu,avx2"
            cross: true
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            features: "cpu,neon"
            cross: true

          # Windows targets
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            features: "cpu,avx2"
            cross: false

          # macOS targets
          - target: x86_64-apple-darwin
            os: macos-latest
            features: "cpu,avx2"
            cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            features: "cpu,neon"
            cross: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross

      - name: Build release binary
        run: |
          if [[ "${{ matrix.cross }}" == "true" ]]; then
            cross build --release --target ${{ matrix.target }} --features ${{ matrix.features }} --bin bitnet
          else
            cargo build --release --target ${{ matrix.target }} --features ${{ matrix.features }} --bin bitnet
          fi

      - name: Create binary archive
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TARGET="${{ matrix.target }}"

          # Determine binary extension
          if [[ "$TARGET" == *"windows"* ]]; then
            BINARY_EXT=".exe"
          else
            BINARY_EXT=""
          fi

          # Create archive directory
          ARCHIVE_DIR="bitnet-${VERSION}-${TARGET}"
          mkdir -p "$ARCHIVE_DIR"

          # Copy binary
          cp "target/${TARGET}/release/bitnet${BINARY_EXT}" "$ARCHIVE_DIR/"

          # Copy additional files
          cp README.md "$ARCHIVE_DIR/"
          cp CHANGELOG.md "$ARCHIVE_DIR/"
          cp LICENSE* "$ARCHIVE_DIR/" 2>/dev/null || true

          # Create archive
          if [[ "$TARGET" == *"windows"* ]]; then
            7z a "${ARCHIVE_DIR}.zip" "$ARCHIVE_DIR"
            echo "ARCHIVE_NAME=${ARCHIVE_DIR}.zip" >> $GITHUB_ENV
          else
            tar czf "${ARCHIVE_DIR}.tar.gz" "$ARCHIVE_DIR"
            echo "ARCHIVE_NAME=${ARCHIVE_DIR}.tar.gz" >> $GITHUB_ENV
          fi

      - name: Generate checksums
        shell: bash
        run: |
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "$ARCHIVE_NAME" > "$ARCHIVE_NAME.sha256"
          elif command -v shasum >/dev/null 2>&1; then
            shasum -a 256 "$ARCHIVE_NAME" > "$ARCHIVE_NAME.sha256"
          else
            echo "No SHA256 tool available"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: |
            ${{ env.ARCHIVE_NAME }}
            ${{ env.ARCHIVE_NAME }}.sha256

  # Build Python wheels
  build-python:
    name: Build Python wheels
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install maturin
        run: pip install maturin

      - name: Build Python wheels
        working-directory: crates/bitnet-py
        run: |
          maturin build --release --features python --compatibility linux
        env:
          CIBW_ARCHS: auto

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels-${{ matrix.os }}
          path: crates/bitnet-py/target/wheels/*.whl

  # Build WebAssembly
  build-wasm:
    name: Build WebAssembly
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WebAssembly package
        working-directory: crates/bitnet-wasm
        run: |
          wasm-pack build --target web --features browser
          wasm-pack build --target nodejs --features nodejs --out-dir pkg-nodejs

      - name: Create WebAssembly archive
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          ARCHIVE_DIR="bitnet-wasm-${VERSION}"
          mkdir -p "$ARCHIVE_DIR"

          cp -r crates/bitnet-wasm/pkg "$ARCHIVE_DIR/web"
          cp -r crates/bitnet-wasm/pkg-nodejs "$ARCHIVE_DIR/nodejs"
          cp README.md "$ARCHIVE_DIR/"

          tar czf "${ARCHIVE_DIR}.tar.gz" "$ARCHIVE_DIR"
          sha256sum "${ARCHIVE_DIR}.tar.gz" > "${ARCHIVE_DIR}.tar.gz.sha256"

      - name: Upload WebAssembly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-build
          path: |
            bitnet-wasm-*.tar.gz
            bitnet-wasm-*.tar.gz.sha256

  # Build Docker images
  build-docker:
    name: Build Docker images
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event.inputs.dry_run != 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: bitnet/bitnet-rs
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event.inputs.dry_run != 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Create GitHub release
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build, build-python, build-wasm, build-docker]
    if: github.event.inputs.dry_run != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -o -name "*.zip" -o -name "*.whl" | while read file; do
            cp "$file" release-assets/
          done
          find artifacts -name "*.sha256" | while read file; do
            cp "$file" release-assets/
          done

      - name: Generate release notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "# BitNet.rs ${VERSION}" > release-notes.md
          echo "" >> release-notes.md

          # Extract changelog for this version
          if [[ -f "CHANGELOG.md" ]]; then
            sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 >> release-notes.md
          else
            echo "**BitNet.rs ${VERSION}** - Production-ready Rust implementation of BitNet 1-bit LLM inference." >> release-notes.md
            echo "" >> release-notes.md
            echo "This release focuses on the Rust implementation as the primary, actively maintained version." >> release-notes.md
          fi

          echo "" >> release-notes.md
          echo "## Assets" >> release-notes.md
          echo "" >> release-notes.md
          echo "### Binaries" >> release-notes.md
          ls release-assets/*.tar.gz release-assets/*.zip 2>/dev/null | while read file; do
            echo "- $(basename "$file")" >> release-notes.md
          done

          echo "" >> release-notes.md
          echo "### Python Wheels" >> release-notes.md
          ls release-assets/*.whl 2>/dev/null | while read file; do
            echo "- $(basename "$file")" >> release-notes.md
          done

          echo "" >> release-notes.md
          echo "### WebAssembly" >> release-notes.md
          ls release-assets/bitnet-wasm-*.tar.gz 2>/dev/null | while read file; do
            echo "- $(basename "$file")" >> release-notes.md
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: BitNet.rs ${{ needs.validate.outputs.version }}
          body_path: release-notes.md
          files: release-assets/*
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to crates.io
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: github.event.inputs.dry_run != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Publish crates in dependency order
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Publish in dependency order
          CRATES=(
            "crates/bitnet-common"
            "crates/bitnet-quantization"
            "crates/bitnet-kernels"
            "crates/bitnet-models"
            "crates/bitnet-tokenizers"
            "crates/bitnet-inference"
            "crates/bitnet-ffi"
            "crates/bitnet-server"
            "crates/bitnet-cli"
            "."  # Main crate
          )

          for crate in "${CRATES[@]}"; do
            echo "Publishing $crate..."
            cd "$crate"

            # Dry run first
            cargo publish --dry-run

            # Actual publish
            cargo publish --no-verify

            # Wait for crates.io to process
            sleep 30

            cd - >/dev/null
          done

  # Publish Python wheels to PyPI
  publish-python:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [validate, build-python]
    if: github.event.inputs.dry_run != 'true'
    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: python-wheels-*
          path: wheels
          merge-multiple: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install twine
        run: pip install twine

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine upload wheels/*.whl

  # Publish WebAssembly to npm
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [validate, build-wasm]
    if: github.event.inputs.dry_run != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Download WebAssembly artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-build
          path: wasm-dist

      - name: Extract and publish WebAssembly packages
        working-directory: wasm-dist
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Extract the archive
          tar xzf bitnet-wasm-*.tar.gz

          # Publish web package
          cd bitnet-wasm-*/web
          npm publish

          # Publish Node.js package
          cd ../nodejs
          npm publish

  # Post-release tasks
  post-release:
    name: Post-release tasks
    runs-on: ubuntu-latest
    needs: [release, publish-crates, publish-python, publish-npm]
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create post-release issue
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.validate.outputs.version }}';
            const issueBody = `
            # Post-release tasks for v${version}

            This issue tracks post-release tasks that need to be completed:

            ## Documentation Updates
            - [ ] Update documentation website
            - [ ] Update API documentation
            - [ ] Update migration guides

            ## Community
            - [ ] Announce release on social media
            - [ ] Update project website
            - [ ] Notify relevant communities

            ## Monitoring
            - [ ] Monitor download statistics
            - [ ] Monitor for issues and bug reports
            - [ ] Check CI/CD pipeline health

            ## Next Release
            - [ ] Plan next release milestones
            - [ ] Update project roadmap
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Post-release tasks for v${version}`,
              body: issueBody,
              labels: ['release', 'task']
            });

      - name: Send release notification
        if: success()
        run: |
          echo "âœ… Release ${{ needs.validate.outputs.version }} completed successfully!"
          echo "ðŸŽ‰ All packages published and release created."
