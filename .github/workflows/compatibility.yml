name: Compatibility Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CARGO_TARGET_DIR: ${{ github.workspace }}/target

jobs:
  msrv:
    name: Minimum Supported Rust Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust 1.90.0
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.90.0
      - name: Check MSRV
        run: |
          cargo check --workspace --all-features
          cargo build --workspace --no-default-features --features cpu

  abi-stability:
    name: ABI Stability Check
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build FFI library
        run: |
          cargo build -p bitnet-ffi --release --no-default-features --features cpu
      - name: Extract symbols (Linux)
        if: runner.os == 'Linux'
        run: |
          nm -D target/release/libbitnet_ffi.so | awk '{print $3}' | grep -E '^(bitnet_|llama_)' | sort > symbols.txt
          diff -u ci/expected-symbols-linux.txt symbols.txt
      - name: Extract symbols (macOS)
        if: runner.os == 'macOS'
        run: |
          nm -gU target/release/libbitnet_ffi.dylib | awk '{print $3}' | sed 's/^_//' | grep -E '^(bitnet_|llama_)' | sort > symbols.txt
          diff -u ci/expected-symbols-macos.txt symbols.txt
      - name: Extract symbols (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          LLVM_NM="$(rustc --print sysroot)/lib/rustlib/x86_64-pc-windows-msvc/bin/llvm-nm.exe"
          "$LLVM_NM" --defined-only target/release/bitnet_ffi.dll | grep -E 'bitnet_|llama_' | awk '{print $3}' | sort > symbols.txt
          diff -u ci/expected-symbols-windows.txt symbols.txt

  ffi-smoke-test:
    name: FFI Smoke Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build FFI library
        run: |
          cargo build -p bitnet-ffi --release --no-default-features --features cpu
      - name: Compile C test
        run: |
          cd crates/bitnet-ffi/tests
          gcc -o test_ffi c_integration_test.c \
            -L../../../target/release -lbitnet_ffi \
            -I../include
      - name: Run C test
        run: |
          cd crates/bitnet-ffi/tests
          if [ "$(uname)" = "Darwin" ]; then
            DYLD_LIBRARY_PATH=../../../target/release ./test_ffi
          else
            LD_LIBRARY_PATH=../../../target/release ./test_ffi
          fi

  validation-pr:
    name: Model Validation (PR Lane)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
          pip install transformers torch scipy
      - name: Build BitNet CLI
        run: |
          cargo build -p bitnet-cli --release --no-default-features --features cpu
      - name: Download test model
        run: |
          # Download small test model for CI (you'll need to set this up)
          echo "Model download would go here"
          # For now, skip if no model available
          if [ ! -f "models/test/model.gguf" ]; then
            echo "No test model available, skipping validation"
            exit 0
          fi
      - name: Run validation suite
        run: |
          if [ -f "models/test/model.gguf" ]; then
            MODEL_PATH=models/test/model.gguf \
            TOKENIZER=models/test/tokenizer.json \
            HF_MODEL_ID=test/model \
            PROP_EXAMPLES=5 \
            TAU_STEPS=10 \
            TAU_MIN=0.60 \
            DELTA_NLL_MAX=1e-2 \
            scripts/validate_all.sh
          fi
      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: validation-artifacts
          path: artifacts/

  tokenizer-fixtures:
    name: Tokenizer Compatibility Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Python dependencies
        run: |
          pip install transformers torch
      - name: Test tokenizer fixtures
        run: |
          cd crates/bitnet-tokenizers
          cargo test --features fixtures -- --nocapture
      - name: Verify GPT-2 compatibility
        run: |
          cargo run --example tokenizer_compat_test -- \
            --model gpt2 \
            --input "Hello, world!" \
            --expected fixtures/gpt2-hello-world.json
      - name: Verify Llama compatibility
        run: |
          cargo run --example tokenizer_compat_test -- \
            --model llama \
            --input "Hello, world!" \
            --expected fixtures/llama-hello-world.json
      - name: Tokenizer parity smoke test
        if: github.event_name == 'pull_request'
        run: |
          # Build BitNet CLI
          cargo build -p bitnet-cli --release --no-default-features --features cpu

          # Run smoke test if model and tokenizer available
          if [ -f "models/test-model.gguf" ] && [ -f "models/tokenizer.json" ]; then
            BITNET_BIN=target/release/bitnet \
            MODEL_PATH=models/test-model.gguf \
            TOKENIZER=models/tokenizer.json \
            HF_MODEL_ID=gpt2 \
            scripts/test-tokenizer-parity.py --smoke
          else
            echo "Skipping tokenizer parity test - model not available"
          fi

  gguf-compat:
    name: GGUF Compatibility Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache test GGUF
        id: cache-gguf
        uses: actions/cache@v4
        with:
          path: test-model.gguf
          key: test-gguf-llama2-q2k-v1
      - name: Download test GGUF
        if: steps.cache-gguf.outputs.cache-hit != 'true'
        run: |
          # Use smaller test model to avoid rate limits - could also use a tiny test GGUF
          wget -q https://huggingface.co/TheBloke/Llama-2-7B-GGUF/resolve/main/llama-2-7b.Q2_K.gguf \
            -O test-model.gguf || \
          echo "Failed to download, using placeholder" && \
          echo "GGUF" > test-model.gguf
      - name: Check GGUF compatibility
        run: |
          cargo run -p bitnet-cli -- compat-check test-model.gguf > compat-report.txt
          grep -q "compatibility issues" compat-report.txt || echo "Model is compatible"
      - name: Test GGUF export
        run: |
          cargo run -p bitnet-cli -- compat-fix test-model.gguf fixed-model.gguf
          test -f fixed-model.gguf.compat.json

  cross-val-determinism:
    name: Cross-Validation Determinism
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Python dependencies
        run: |
          pip install hypothesis transformers torch
      - name: Download test model
        run: cargo xtask download-model
      - name: Build C++ implementation
        run: cargo xtask fetch-cpp
      - name: Run deterministic cross-validation
        env:
          BITNET_GGUF: models/microsoft-bitnet-b1.58-2B-4T-gguf/ggml-model-i2_s.gguf
          BITNET_DETERMINISTIC: 1
          BITNET_SEED: 42
          PARITY_ARTIFACT: artifacts/parity_failures.jsonl
        run: |
          cargo test --package crossval --features deterministic -- \
            --test eval_ids_parity \
            --nocapture
      - name: Upload parity artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: parity-artifacts
          path: artifacts/*.jsonl

  audit-and-deny:
    name: Security and License Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Install cargo-deny
        run: cargo install cargo-deny
      - name: Run security audit
        run: cargo audit
      - name: Check licenses
        run: cargo deny check licenses
      - name: Check dependencies
        run: cargo deny check bans

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov
      - name: Generate coverage
        run: |
          cargo llvm-cov --workspace --features cpu --html
          cargo llvm-cov --workspace --features cpu --text | tee coverage.txt
      - name: Check coverage threshold
        run: |
          awk '/TOTAL/ {gsub(/%/,"",$(NF)); v=$(NF)+0; print "Coverage:", v"%"; if (v < 70) {print "Coverage below 70% threshold"; exit 1}}' coverage.txt
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/llvm-cov/html/
