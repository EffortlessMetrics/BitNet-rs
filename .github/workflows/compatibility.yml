name: Compatibility Tests

on:
  push:
    branches: [main]
    paths:
      - 'crates/bitnet-ffi/**'
      - 'crates/bitnet-tokenizers/**'
      - 'crates/bitnet-models/**'
      - 'crates/bitnet-py/**'
      - 'include/**'
  pull_request:
    paths:
      - 'crates/bitnet-ffi/**'
      - 'crates/bitnet-tokenizers/**'
      - 'crates/bitnet-models/**'
      - 'crates/bitnet-py/**'
      - 'include/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Test FFI API compatibility
  ffi-compatibility:
    name: FFI API Compatibility
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, 1.89.0]  # MSRV
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-ffi-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run FFI contract tests
        run: |
          cargo test -p bitnet-ffi --test api_contract --no-default-features --features cpu
      
      - name: Check C header compatibility
        run: |
          # Verify header compiles with C compiler
          echo '#include "include/llama_compat.h"' > test.c
          echo 'int main() { return 0; }' >> test.c
          gcc -c test.c -I. -o test.o || clang -c test.c -I. -o test.o
      
      - name: Build static library
        run: |
          cargo build -p bitnet-ffi --release --no-default-features --features cpu
          # Verify .a/.lib file exists
          ls target/release/*.a || ls target/release/*.lib || true

  # Test tokenizer compatibility
  tokenizer-compatibility:
    name: Tokenizer Compatibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Run tokenizer contract tests
        run: |
          cargo test -p bitnet-tokenizers --test tokenizer_contracts
      
      - name: Test GPT-2 tokenizer regression
        run: |
          # This is the tokenizer that breaks llama.cpp
          cargo test -p bitnet-tokenizers --test tokenizer_contracts test_gpt2_llama_cpp_regression

  # Test GGUF compatibility
  gguf-compatibility:
    name: GGUF Compatibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Run GGUF compatibility tests
        run: |
          cargo test -p bitnet-models --test gguf_compatibility
      
      - name: Test Microsoft BitNet model fix
        run: |
          # Test the specific model that breaks llama.cpp
          cargo test -p bitnet-models --test gguf_compatibility test_microsoft_bitnet_model_fix

  # Test Python API compatibility
  python-compatibility:
    name: Python API Compatibility
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: ['3.8', '3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      
      - name: Install Python dependencies
        run: |
          pip install pytest maturin
      
      - name: Build Python module
        run: |
          cd crates/bitnet-py
          maturin develop
      
      - name: Run Python contract tests
        run: |
          cd crates/bitnet-py
          pytest tests/test_llama_compat.py -v
      
      - name: Test import compatibility
        run: |
          python -c "from bitnet.llama_compat import Llama, LlamaCache"

  # Integration test with real model
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Download test model
        run: |
          # Download a small test model if available
          # For now, skip if not available
          echo "Integration test would run here with real model"
      
      - name: Test C++ compatibility
        run: |
          # Build example C program using our API
          gcc examples/c_example.c -L target/release -lbitnet_ffi -o test_c || true
          ./test_c || true
      
      - name: Test Python compatibility
        run: |
          # Run Python example
          python examples/llama_cpp_migration.py || true

  # ABI stability check
  abi-stability:
    name: ABI Stability Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-abi-checker (if available)
        run: |
          # Tool to check ABI stability
          cargo install cargo-abi-checker || true
      
      - name: Generate ABI snapshot
        run: |
          # Generate ABI information for comparison
          cargo build -p bitnet-ffi --release --no-default-features --features cpu
          nm -D target/release/libbitnet_ffi.so > abi_snapshot.txt || true
      
      - name: Check ABI compatibility
        run: |
          # In PR, compare against main branch ABI
          echo "ABI check would run here"

  # Performance regression check
  performance-check:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Run benchmarks
        run: |
          cargo bench -p bitnet-tokenizers --no-default-features --features cpu -- --save-baseline pr
      
      - name: Compare with main
        run: |
          # Would compare against main branch baseline
          echo "Performance comparison would run here"

  # All tests must pass
  all-compatibility-tests:
    name: All Compatibility Tests
    runs-on: ubuntu-latest
    needs:
      - ffi-compatibility
      - tokenizer-compatibility
      - gguf-compatibility
      - python-compatibility
      - abi-stability
    if: always()
    steps:
      - name: Check all tests passed
        run: |
          if [[ "${{ needs.ffi-compatibility.result }}" != "success" || \
                "${{ needs.tokenizer-compatibility.result }}" != "success" || \
                "${{ needs.gguf-compatibility.result }}" != "success" || \
                "${{ needs.python-compatibility.result }}" != "success" || \
                "${{ needs.abi-stability.result }}" != "success" ]]; then
            echo "Some compatibility tests failed!"
            exit 1
          fi
          echo "âœ… All compatibility tests passed!"