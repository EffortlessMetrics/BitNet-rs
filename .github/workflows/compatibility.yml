name: Compatibility Tests

on:
  push:
    branches: [main]
    paths:
      - 'crates/**'
      - 'crossval/**'
      - 'xtask/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/compatibility.yml'
  pull_request:
    branches: [main]
    paths:
      - 'crates/**'
      - 'crossval/**'
      - 'xtask/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/compatibility.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CARGO_TARGET_DIR: ${{ github.workspace }}/target

jobs:
  msrv:
    name: Minimum Supported Rust Version
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: "0"
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Install Rust 1.89.0
        uses: dtolnay/rust-toolchain@6d653acede28d24f02e3cd41383119e8b1b35921  # master
        with:
          toolchain: 1.89.0

      - name: Cache (MSRV)
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0  # v2
        with:
          # MSRV-specific key to avoid collisions with 1.90/stable
          shared-key: msrv-1_89

      - name: Warm fetch (locked)
        run: cargo fetch --locked

      - name: MSRV check (workspace, no codegen)
        run: |
          cargo --version && rustc --version
          cargo check --workspace --all-targets --locked --no-default-features --features cpu

  abi-stability:
    name: ABI Stability Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4
      - uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.89.0"
      - name: Build FFI library
        run: |
          cargo build -p bitnet-ffi --locked --release --no-default-features --features cpu
      - name: Extract symbols (Linux)
        run: |
          nm -D target/release/libbitnet_ffi.so | awk '{print $3}' | grep -E '^(bitnet_|llama_)' | sort > symbols.txt
          diff -u ci/expected-symbols-linux.txt symbols.txt || echo "Symbol diff found (may be expected during development)"

  ffi-smoke-test:
    name: FFI Smoke Test
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4
      - uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.89.0"
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake clang pkg-config || true
      - name: Build FFI library
        run: |
          cargo build -p bitnet-ffi --locked --release --no-default-features --features cpu || true
      - name: Export LD_LIBRARY_PATH
        run: echo "LD_LIBRARY_PATH=$PWD/target/release:$LD_LIBRARY_PATH" >> $GITHUB_ENV || true
      - name: Compile C test
        run: |
          cd crates/bitnet-ffi/tests
          gcc -o test_ffi c_integration_test.c \
            -L../../../target/release -lbitnet_ffi \
            -I../include || true
      - name: Run C test
        run: |
          cd crates/bitnet-ffi/tests
          LD_LIBRARY_PATH=../../../target/release ./test_ffi || true

  validation-pr:
    name: Model Validation (PR Lane)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4
      - uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.89.0"
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
          pip install transformers torch scipy
      - name: Build BitNet CLI
        run: |
          cargo build -p bitnet-cli --locked --release --no-default-features --features cpu
      - name: Download test model
        run: |
          # Download small test model for CI (you'll need to set this up)
          echo "Model download would go here"
          # For now, skip if no model available
          if [ ! -f "models/test/model.gguf" ]; then
            echo "No test model available, skipping validation"
            exit 0
          fi
      - name: Run validation suite
        run: |
          if [ -f "models/test/model.gguf" ]; then
            MODEL_PATH=models/test/model.gguf \
            TOKENIZER=models/test/tokenizer.json \
            HF_MODEL_ID=test/model \
            PROP_EXAMPLES=5 \
            TAU_STEPS=10 \
            TAU_MIN=0.60 \
            DELTA_NLL_MAX=1e-2 \
            scripts/validate_all.sh
          fi
      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: validation-artifacts
          path: artifacts/

  tokenizer-fixtures:
    name: Tokenizer Compatibility Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # Informational while stabilizing baselines
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4
      - uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.89.0"
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: '3.10'
      - name: Install Python dependencies
        run: |
          python -m pip install -U pip setuptools wheel
          pip install "transformers==4.44.2" "tokenizers==0.19.1" "torch==2.*" "scipy==1.*"
      - name: Configure offline mode
        run: |
          echo "TOKENIZERS_PARALLELISM=false" >> $GITHUB_ENV
          echo "HF_HUB_DISABLE_TELEMETRY=1" >> $GITHUB_ENV
          echo "TRANSFORMERS_OFFLINE=1" >> $GITHUB_ENV
      - name: Ensure tokenizer fixtures
        run: |
          cd crates/bitnet-tokenizers
          mkdir -p fixtures
          cp -r ../../tests/fixtures/tokenizers/* fixtures/ || true
      - name: Test tokenizer fixtures
        run: |
          cd crates/bitnet-tokenizers
          cargo test --locked --features fixtures -- --nocapture || true
      - name: Verify GPT-2 compatibility
        run: |
          cargo run --locked --example tokenizer_compat_test -- \
            --model gpt2 \
            --input "Hello, world!" \
            --expected fixtures/gpt2-hello-world.json || true
      - name: Verify Llama compatibility
        run: |
          cargo run --locked --example tokenizer_compat_test -- \
            --model llama \
            --input "Hello, world!" \
            --expected fixtures/llama-hello-world.json || true
      - name: Tokenizer parity smoke test
        if: github.event_name == 'pull_request'
        run: |
          # Build BitNet CLI
          cargo build -p bitnet-cli --locked --release --no-default-features --features cpu || true

          # Run smoke test if model and tokenizer available
          if [ -f "models/test-model.gguf" ] && [ -f "models/tokenizer.json" ]; then
            BITNET_BIN=target/release/bitnet \
            MODEL_PATH=models/test-model.gguf \
            TOKENIZER=models/tokenizer.json \
            HF_MODEL_ID=gpt2 \
            scripts/test-tokenizer-parity.py --smoke || true
          else
            echo "Skipping tokenizer parity test - model not available"
          fi

  gguf-compat:
    name: GGUF Compatibility Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4
      - uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.89.0"
      - name: Cache test GGUF
        id: cache-gguf
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4
        with:
          path: test-model.gguf
          key: test-gguf-llama2-q2k-v1
      - name: Download test GGUF
        if: steps.cache-gguf.outputs.cache-hit != 'true'
        run: |
          # Use smaller test model to avoid rate limits - could also use a tiny test GGUF
          wget -q https://huggingface.co/TheBloke/Llama-2-7B-GGUF/resolve/main/llama-2-7b.Q2_K.gguf \
            -O test-model.gguf || \
          echo "Failed to download, using placeholder" && \
          echo "GGUF" > test-model.gguf
      - name: Check GGUF compatibility
        run: |
          cargo run --locked -p bitnet-cli --no-default-features --features cpu -- compat-check test-model.gguf > compat-report.txt || echo "Compatibility check completed"
          grep -q "compatibility issues" compat-report.txt || echo "Model is compatible"
      - name: Test GGUF export
        run: |
          cargo run --locked -p bitnet-cli --no-default-features --features cpu -- compat-fix test-model.gguf fixed-model.gguf || echo "Export completed"
          test -f fixed-model.gguf.compat.json || echo "Compat JSON not generated (expected for some models)"

  cross-val-determinism:
    name: Cross-Validation Determinism
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: contains(github.event.pull_request.labels.*.name, 'crossval')
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4
      - uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.89.0"
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: '3.10'
      - name: Install Python dependencies
        run: |
          pip install hypothesis transformers torch
      - name: Download test model
        run: cargo xtask download-model
      - name: Build C++ implementation
        run: cargo xtask fetch-cpp
      - name: Run deterministic cross-validation
        env:
          BITNET_GGUF: models/microsoft-bitnet-b1.58-2B-4T-gguf/ggml-model-i2_s.gguf
          BITNET_DETERMINISTIC: 1
          BITNET_SEED: 42
          PARITY_ARTIFACT: artifacts/parity_failures.jsonl
        run: |
          cargo test --locked --package crossval --features deterministic -- \
            --test eval_ids_parity \
            --nocapture
      - name: Upload parity artifacts on failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: parity-artifacts
          path: artifacts/*.jsonl

  audit-and-deny:
    name: Security and License Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # Non-blocking for PRs
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4
      - uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.89.0"
      - name: Install cargo-audit
        run: cargo install cargo-audit || true
      - name: Install cargo-deny
        run: cargo install cargo-deny || true
      - name: Run security audit
        run: cargo audit || true
      - name: Check licenses
        run: cargo deny check licenses || true
      - name: Check dependencies
        run: cargo deny check bans || true

  # coverage:
  #   MOVED TO: .github/workflows/coverage.yml
  #   This job was migrated to a dedicated coverage workflow with:
  #     - Strict 70% threshold on main (blocks push)
  #     - Label-gated on PRs (opt-in via 'coverage' label)
  #     - Separate workflow for better control and visibility
  #   See: .github/workflows/coverage.yml
  #   if: ${{ false }}  # Disabled - legacy job
