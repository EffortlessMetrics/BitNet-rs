name: CI (Core)

# Core gating checks that MUST pass for PR merges (Linux-only).
# This workflow is designed to be fast, reliable, and reproducible locally via ci/local.sh
# Note: This workflow triggers on changes to crates/**, Cargo.{toml,lock}, README.md, docs/**, SECURITY.md, issue templates, and this file itself
# Workflow hardening: concurrency + timeouts applied across all workflows in #485

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/ci-core.yml'
      - 'README.md'
      - 'docs/**'
      - 'SECURITY.md'
      - '.github/ISSUE_TEMPLATE/**'
  push:
    branches: [ main ]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/ci-core.yml'
      - 'README.md'
      - 'docs/**'
      - 'SECURITY.md'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RUSTFLAGS: "-Dwarnings"
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Job 1: Build and test on Linux
  # Note: Job name kept as 'ubuntu-latest' for branch protection rule compatibility,
  # but runner is pinned to ubuntu-22.04 for CI reproducibility.
  build-test-linux:
    name: Build & Test (ubuntu-latest)
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    env:
      RUSTFLAGS: "-D warnings"
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: "0"
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.90.0"
          components: clippy,rustfmt

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0  # v2
        with:
          shared-key: ci-core-ubuntu

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Build core crates (libs, CPU features)
        run: |
          cargo build --locked \
            -p bitnet-common \
            -p bitnet-models \
            -p bitnet-tokenizers \
            -p bitnet-quantization \
            -p bitnet-kernels \
            --no-default-features --features cpu

      - name: Run unit tests (libs only, CPU features)
        run: |
          # Target only the library crates to keep feedback fast.
          cargo test --locked \
            -p bitnet-common \
            -p bitnet-models \
            -p bitnet-tokenizers \
            -p bitnet-quantization \
            -p bitnet-kernels \
            --lib \
            --no-default-features --features cpu \
            -- --nocapture

  # Job 2: Clippy linting
  clippy:
    name: Clippy
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    env:
      RUSTFLAGS: "-D warnings"
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: "0"
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.90.0"
          components: clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0  # v2
        with:
          shared-key: ci-core-clippy

      - name: Run clippy (core crates, libs only)
        run: |
          cargo clippy --locked \
            -p bitnet-common \
            -p bitnet-models \
            -p bitnet-tokenizers \
            -p bitnet-quantization \
            -p bitnet-kernels \
            --lib \
            --no-default-features --features cpu

  # Job 4: Documentation build
  docs:
    name: Documentation
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          toolchain: "1.90.0"

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0  # v2
        with:
          shared-key: ci-core-docs

      - name: Build documentation
        run: cargo doc --locked --no-deps --workspace --no-default-features --features cpu

  # Summary job (required for branch protection)
  ci-core-success:
    name: CI Core Success
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    needs: [build-test-linux, clippy, docs]
    if: always()
    steps:
      - name: Summarize core results
        if: always()
        run: |
          echo "Core results:"
          echo "  Build & Test: ${{ needs.build-test-linux.result }}"
          echo "  Clippy:       ${{ needs.clippy.result }}"
          echo "  Docs:         ${{ needs.docs.result }}"

      - name: Check all jobs succeeded
        if: always()
        run: |
          bad=0
          for r in "${{ needs.build-test-linux.result }}" \
                   "${{ needs.clippy.result }}" \
                   "${{ needs.docs.result }}"; do
            [ "$r" = "success" ] || bad=1
          done
          if [ $bad -ne 0 ]; then
            echo "❌ One or more core CI jobs failed (or were cancelled)"; exit 1
          fi
          echo "✅ Core CI jobs succeeded"
