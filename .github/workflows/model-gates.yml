name: Model Gates (CPU Receipt Verification)

# This workflow enforces honest compute by requiring valid inference receipts.
# It produces a receipt via `xtask benchmark` with measured TPS and real kernel IDs,
# then verifies it with `xtask verify-receipt`. This is the keystone for enforceable
# CPU MVP gates with production-ready receipt generation.

on:
  pull_request:
    types: [opened, reopened, synchronize, labeled, ready_for_review]
    branches: [main]
    paths:
      - "crates/bitnet-inference/**"
      - "crates/bitnet-kernels/**"
      - "crates/bitnet-models/**"
      - "crates/bitnet-cli/**"
      - "xtask/**"
      - ".github/workflows/model-gates.yml"
  workflow_dispatch: {}
  schedule:
    # Run nightly at 4 AM UTC for strict validation
    - cron: '0 4 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  # Deterministic inference for reproducible receipts
  BITNET_DETERMINISTIC: "1"
  BITNET_SEED: "42"
  RAYON_NUM_THREADS: "1"
  # Git metadata for vergen-gix
  VERGEN_GIT_SHA: ${{ github.sha }}
  VERGEN_GIT_BRANCH: ${{ github.ref_name }}
  VERGEN_GIT_DESCRIBE: ${{ github.ref_name }}-${{ github.sha }}
  VERGEN_IDEMPOTENT: "1"

jobs:
  cpu-receipt-gate:
    name: CPU Receipt Gate
    # Run on PRs only when 'receipts' label is present; always run for manual/scheduled and main.
    if: >
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'receipts')) ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      startsWith(github.ref, 'refs/heads/main')
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    permissions:
      contents: read
    concurrency:
      group: receipts-gate-${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0  # v2
        with:
          shared-key: "model-gates-cpu"
          cache-all-crates: true
          cache-targets: true

      - name: Build xtask
        run: |
          echo "üî® Building xtask..."
          cargo build --locked -p xtask --release --locked

      - name: Build bitnet-cli (CPU)
        run: |
          echo "üî® Building bitnet-cli with CPU features..."
          cargo build --locked -p bitnet-cli --release --no-default-features --features cpu,full-cli --locked

      - name: Run benchmark and write receipt
        run: |
          echo "üß™ Running benchmark and writing receipt (ci/inference.json)..."
          echo ""
          echo "This runs a tiny deterministic inference benchmark (128 tokens)"
          echo "and writes a receipt with measured tokens/sec and real kernel IDs."
          echo ""
          cargo run --locked -p xtask --locked -- benchmark --model tests/models/mini.gguf --tokens 128

      - name: Display receipt
        run: |
          echo "üìÑ Generated receipt:"
          cat ci/inference.json | jq '.'

      - name: Verify receipt (strict)
        run: |
          echo "üîç Verifying receipt against quality gates..."
          cargo run --locked -p xtask --locked -- verify-receipt --path ci/inference.json

      - name: Upload receipt artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: cpu-inference-receipt
          path: ci/inference.json
          retention-days: 30

      - name: Generate gate report
        if: always()
        run: |
          cat > cpu-receipt-gate-report.md << 'EOF'
          # CPU Receipt Gate Report

          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow Run**: ${{ github.run_id }}
          **Commit**: ${{ github.sha }}

          ## Receipt Verification

          This gate ensures honest compute by requiring valid inference receipts.

          ### Configuration

          - **Deterministic Mode**: BITNET_DETERMINISTIC=1 (seed=42)
          - **Single-threaded**: RAYON_NUM_THREADS=1
          - **Receipt Schema**: 1.0.0

          ### Validation Checks

          ‚úÖ Schema version compatibility (1.0.0 or 1.0)
          ‚úÖ compute_path == "real" (not "mock")
          ‚úÖ kernels[] is non-empty with valid kernel IDs
          ‚úÖ kernels[] hygiene: no empty strings, length ‚â§ 128 chars, count ‚â§ 10,000
          ‚úÖ GPU backend auto-enforces GPU kernel presence (when backend="cuda")
          ‚úÖ All kernel entries are strings

          ### Status

          See workflow logs for detailed verification output and receipt contents.

          ### Production Receipt Generation

          The `benchmark` command now writes production-ready receipts with:
          1. Measured tokens/sec throughput from actual inference
          2. Real kernel IDs captured during execution
          3. Deterministic configuration for reproducibility
          4. Complete environment metadata for traceability

          This provides honest compute evidence for all BitNet.rs inference operations.
          EOF

          cat cpu-receipt-gate-report.md

      - name: Upload gate report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: cpu-receipt-gate-report
          path: cpu-receipt-gate-report.md
          retention-days: 30

  gate-summary:
    name: Receipt Gate Summary
    needs: cpu-receipt-gate
    if: always()
    # Same gating as the main job, so we don't surface red on PRs without the label.
    # Note: The outer if: always() ensures this runs even if cpu-receipt-gate is skipped.
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Check gate result
        run: |
          echo "## CPU Receipt Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.cpu-receipt-gate.result }}" == "success" ]]; then
            echo "‚úÖ **CPU Receipt Gate**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Receipt verification completed successfully." >> $GITHUB_STEP_SUMMARY
            echo "The receipt proves honest compute with real kernel execution." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **CPU Receipt Gate**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Receipt verification failed. This may indicate:" >> $GITHUB_STEP_SUMMARY
            echo "- Invalid receipt schema" >> $GITHUB_STEP_SUMMARY
            echo "- compute_path != 'real' (mock inference)" >> $GITHUB_STEP_SUMMARY
            echo "- Empty kernels array" >> $GITHUB_STEP_SUMMARY
            echo "- Missing required fields" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the job logs for detailed failure information." >> $GITHUB_STEP_SUMMARY
          fi

      # Fail loudly on main/nightly, not on PRs.
      - name: Verify gate passed (main/nightly only)
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          if [[ "${{ needs.cpu-receipt-gate.result }}" != "success" ]]; then
            echo "‚ùå CPU Receipt Gate failed"
            exit 1
          fi

          echo "‚úÖ CPU Receipt Gate passed - honest compute verified"

      - name: Report gate status (PRs)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          if [[ "${{ needs.cpu-receipt-gate.result }}" == "success" ]]; then
            echo "‚úÖ CPU Receipt Gate passed - honest compute verified"
          else
            echo "‚ö†Ô∏è  CPU Receipt Gate failed (informational on PRs)"
            echo "This is not blocking the PR. See logs for details."
          fi
