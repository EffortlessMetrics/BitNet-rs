name: Quantization Matrix CI

on:
  push:
    branches: [ main ]
  pull_request:
    types: [labeled, synchronize, reopened]
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -D warnings

jobs:
  build-matrix:
    name: Build ${{ matrix.features }}
    # Only run when explicitly requested via label
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'quant')
    runs-on: ubuntu-22.04
    continue-on-error: true
    timeout-minutes: 8
    strategy:
      matrix:
        features:
          - "cpu"
          - "cpu,iq2s-ffi"
      fail-fast: false

    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
      with:
        toolchain: 1.89.0

    - name: Rust Cache
      uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0  # v2
      with:
        workspaces: |
          . -> target
        key: ${{ matrix.features }}

    - name: Verify vendored GGML commit
      if: contains(matrix.features, 'iq2s-ffi')
      continue-on-error: true
      run: |
        test -s crates/bitnet-ggml-ffi/csrc/VENDORED_GGML_COMMIT || exit 0
        ! grep -qx "unknown" crates/bitnet-ggml-ffi/csrc/VENDORED_GGML_COMMIT || exit 0

    - name: Probe feature availability
      id: probe
      continue-on-error: true
      run: |
        # Fast probe: check if feature combo builds in 5 seconds
        if timeout 5s cargo check --locked -p bitnet-cli --no-default-features --features "${{ matrix.features }}" >/dev/null 2>&1; then
          echo "available=true" >> $GITHUB_OUTPUT
          echo "✅ Feature combo available: ${{ matrix.features }}"
        else
          echo "available=false" >> $GITHUB_OUTPUT
          echo "⏭️ Skipping unavailable feature combo: ${{ matrix.features }}"
        fi

    - name: Clippy Check
      if: steps.probe.outputs.available == 'true'
      run: |
        cargo clippy --workspace \ --locked
          --locked \
          --no-default-features \
          --features "${{ matrix.features }}" \
          --all-targets \
          -- -D warnings || true

    - name: Build
      if: steps.probe.outputs.available == 'true'
      run: |
        cargo build -p bitnet-cli \ --locked
          --locked \
          --no-default-features \
          --features "${{ matrix.features }}" \
          --release || true

    - name: Run tests
      if: steps.probe.outputs.available == 'true'
      run: |
        cargo test --workspace \ --locked
          --locked \
          --no-default-features \
          --features "${{ matrix.features }}" \
          -- --nocapture || true

    - name: Acceptance Test (IQ2_S)
      if: steps.probe.outputs.available == 'true' && contains(matrix.features, 'iq2s-ffi')
      env:
        IQ2S_MODEL: ${{ secrets.IQ2S_TEST_MODEL }}
      run: |
        if [ -n "$IQ2S_MODEL" ]; then
          scripts/test-iq2s-acceptance.sh \
            --model "$IQ2S_MODEL" \
            --timeout 30
        else
          echo "Skipping acceptance test: IQ2S_MODEL secret not configured"
        fi

    - name: Store binary artifact
      if: steps.probe.outputs.available == 'true'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
      with:
        name: bitnet-cli-${{ matrix.features }}
        path: target/release/bitnet

  smoke-test:
    name: Smoke Test Quantization
    # Only run when explicitly requested via label
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'quant')
    runs-on: ubuntu-22.04
    needs: build-matrix
    continue-on-error: true

    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

    - name: Download I2_S binary
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
      with:
        name: bitnet-cli-cpu
        path: ./bin
      continue-on-error: true

    - name: Download IQ2_S binary
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
      with:
        name: bitnet-cli-cpu,iq2s-ffi
        path: ./bin-iq2s
      continue-on-error: true

    - name: Make binaries executable
      run: |
        chmod +x ./bin/bitnet || true
        chmod +x ./bin-iq2s/bitnet || true

    - name: Test I2_S binary version
      run: |
        echo "=== I2_S Binary (cpu only) ==="
        ./bin/bitnet --version || true
        echo

    - name: Test IQ2_S binary version
      run: |
        echo "=== IQ2_S Binary (cpu,iq2s-ffi) ==="
        ./bin-iq2s/bitnet --version || true
        echo

    # Future: download test model slices and run inspect/decode tests
    # - name: Test I2_S model inspect
    #   run: |
    #     env RUST_LOG=error ./bin/bitnet inspect \
    #       --model tests/data/sample_i2s.gguf \
    #       --json | jq '.quantization'

    # - name: Test IQ2_S model inspect
    #   run: |
    #     env RUST_LOG=error ./bin-iq2s/bitnet inspect \
    #       --model tests/data/sample_iq2s.gguf \
    #       --json | jq '.quantization,.environment.ggml_commit'

  parity-test:
    name: Parity Test (when slices exist)
    runs-on: ubuntu-22.04
    needs: build-matrix
    if: false # Enable when test data is available

    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@5d458579430fc14a04a08a1e7d3694f545e91ce6  # stable
      with:
        toolchain: 1.89.0

    - name: Run IQ2_S parity test
      run: |
        # When test slices are committed:
        cargo test -p bitnet-models \ --locked
          --no-default-features \
          --features "cpu,iq2s-ffi" \
          --test iq2s_tests \
          -- --nocapture
