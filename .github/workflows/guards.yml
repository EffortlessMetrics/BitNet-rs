name: Guards
on:
  pull_request:
    paths:
      - "tests/**"
      - "crates/**"
      - "scripts/*.sh"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/**"
      - ".github/pull_request_template.md"
      - ".github/ISSUE_TEMPLATE/**"
  push:
    branches: [main]
    paths:
      - "tests/**"
      - "crates/**"
      - "scripts/*.sh"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/**"
      - ".github/pull_request_template.md"
      - ".github/ISSUE_TEMPLATE/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  guards:
    name: Guards
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Ensure ripgrep exists
        run: |
          if ! command -v rg >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y ripgrep
          fi

      # Ensure scripts are executable in fresh clones
      - run: chmod +x scripts/*.sh || true

      - name: Guard - no floating action refs
        run: |
          # Exclude guards.yml itself to avoid matching its own regex patterns
          if rg -n --color=never --glob '!guards.yml' \
               -e '^\s*uses:\s*[^ @]+/[^ @]+@(?:v[0-9]+(?:\.[0-9]+)*)\b' \
               -e '^\s*uses:\s*[^ @]+/[^ @]+@(?:stable|main|master|latest)\b' \
               .github/workflows; then
            echo "❌ Floating GitHub Action refs detected (must use SHA pins)"
            exit 1
          fi
          echo "✅ All actions pinned to SHA refs"

      - name: Guard - actions pinned to 40-hex SHA
        run: |
          # External actions must be pinned to exactly 40 hex chars.
          # Local actions like "./.github/actions/..." are allowed.
          if rg -n --color=never --glob '!guards.yml' \
               -e '^\s*uses:\s*(?!\./)[^ @]+/[^ @]+@(?![0-9a-f]{40}\b)' \
               .github/workflows; then
            echo "❌ Non-immutable action pin detected (must be 40-hex SHA)"
            exit 1
          fi
          echo "✅ All actions pinned to 40-hex SHAs"

      - name: Guard - MSRV consistency (1.92.0 only)
        run: |
          # Restrict matches to actual toolchain declarations or explicit JSON/env
          if rg -n --color=never --glob '!guards.yml' \
               -e 'toolchain:\s*"?1\.90\.0"?' \
               -e 'rust-version\s*=\s*"1\.90\.0"' \
               -e '"RUST_VERSION"\s*:\s*"1\.90\.0"' \
               .github/workflows; then
            echo "❌ Found stale toolchain 1.90.0 in workflows (MSRV is 1.92.0)"
            exit 1
          fi
          echo "✅ MSRV consistent across all workflows (1.92.0)"

      - name: Check units
        run: ./scripts/check-units.sh || true
      - name: Check envlock
        run: ./scripts/check-envlock.sh || true
      - name: Make check-units-imports executable
        run: chmod +x scripts/check-units-imports.sh || true
      - name: Check units imports
        run: ./scripts/check-units-imports.sh || true
      - name: Guard dev-only flags (informational)
        run: |
          set +e
          if rg -n 'BITNET_FIX_LN_SCALE\s*=\s*1' .github/workflows; then
            echo "WARNING: BITNET_FIX_LN_SCALE should not be set in CI (deprecated - use correction policy)"
          fi
          if rg -n 'BITNET_CORRECTION_POLICY\s*=' .github/workflows; then
            echo "WARNING: BITNET_CORRECTION_POLICY should not be set in CI (corrections are for known-bad models only)"
          fi
          if rg -n 'BITNET_ALLOW_RUNTIME_CORRECTIONS\s*=\s*1' .github/workflows; then
            echo "WARNING: BITNET_ALLOW_RUNTIME_CORRECTIONS should not be set in CI (corrections are for known-bad models only)"
          fi
          echo "✅ Dev-only flags check completed"
          exit 0
      - name: Guard bare cfg(cuda) in tests (informational)
        run: |
          set +e
          if rg -n '#\[cfg\(cuda\)\]|cfg!\(cuda\)' --glob 'crates/**/tests/**/*.rs'; then
            echo "WARNING: Use #[cfg(any(feature=\"gpu\", feature=\"cuda\"))] instead of bare cfg(cuda) in tests"
          else
            echo "✅ No bare cfg(cuda) in tests"
          fi
          exit 0
      - name: Guard - cargo/cross --locked everywhere
        run: |
          # We allow: 'cargo|cross (build|test|run|bench|clippy) ... --locked'
          # Exclude guards.yml (contains the regex itself)
          violations=$(
            rg -n --color=never --glob '*.yml' --glob '!guards.yml' \
               -e '\b(cargo|cross)\s+(build|test|run|bench|clippy)\b' \
               .github/workflows \
            | grep -v -- '--locked' || true
          )
          if [ -n "$violations" ]; then
            echo "❌ Missing --locked in workflow cargo/cross command(s):"
            echo "$violations"
            echo
            echo "All cargo/cross build/test/run/bench/clippy commands must use --locked (before any standalone ' -- ')."
            exit 1
          fi
          echo "✅ All workflow cargo/cross commands use --locked"
      - name: Guard - receipt workflow excludes python/wasm
        run: |
          f=".github/workflows/verify-receipts.yml"

          # We expect both excludes to appear in CPU *and* GPU build steps (2+ hits each)
          want=2
          pyc=$(rg -n -- '--exclude bitnet-py'   "$f" | wc -l | tr -d ' ')
          was=$(rg -n -- '--exclude bitnet-wasm' "$f" | wc -l | tr -d ' ')

          if [ "$pyc" -lt "$want" ] || [ "$was" -lt "$want" ]; then
            echo "❌ ${f} is missing required excludes in both CPU and GPU lanes:"
            echo "   --exclude bitnet-py   occurrences: $pyc (need >= $want)"
            echo "   --exclude bitnet-wasm occurrences: $was (need >= $want)"
            echo ""
            echo "Expected: receipt builds exclude Python/WASM bindings to avoid libpython/linker deps."
            exit 1
          fi

          echo "✅ receipt workflow excludes python/wasm in CPU+GPU lanes"
      - name: Upload guard logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: guards-report
          path: |
            **/guards*.log
            **/guards*.txt
          retention-days: 3
