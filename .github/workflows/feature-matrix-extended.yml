# Extended Feature-Matrix CI
#
# Validates compile-time compatibility for GPU backend feature-flag
# combinations that go beyond the baseline `feature-matrix.yml`.
# Each entry runs `cargo check` only â€” no linking or test execution.

name: Feature Matrix Extended (GPU backends)

on:
  push:
    branches: [main, "intel-gpu/**"]
    paths:
      - "crates/bitnet-kernels/**"
      - "crates/bitnet-common/**"
      - "crates/bitnet-device-probe/**"
      - "crates/bitnet-inference/**"
      - "crates/bitnet-testing-policy-tests/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/feature-matrix-extended.yml"
  pull_request:
    branches: [main, "intel-gpu/**"]
    paths:
      - "crates/bitnet-kernels/**"
      - "crates/bitnet-common/**"
      - "crates/bitnet-device-probe/**"
      - "crates/bitnet-inference/**"
      - "crates/bitnet-testing-policy-tests/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/feature-matrix-extended.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  gpu-feature-matrix:
    name: "check (${{ matrix.label }})"
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          # Single-backend combinations
          - label: "cpu"
            flags: "--no-default-features --features cpu"
          - label: "oneapi"
            flags: "--no-default-features --features oneapi"
            allow_failure: true
          - label: "gpu"
            flags: "--no-default-features --features gpu"
            allow_failure: true

          # Two-backend combinations
          - label: "cpu+oneapi"
            flags: "--no-default-features --features cpu,oneapi"
            allow_failure: true
          - label: "gpu+oneapi"
            flags: "--no-default-features --features gpu,oneapi"
            allow_failure: true
          - label: "cpu+gpu"
            flags: "--no-default-features --features cpu,gpu"
            allow_failure: true

          # Three-backend (all GPU paths)
          - label: "cpu+gpu+oneapi"
            flags: "--no-default-features --features cpu,gpu,oneapi"
            allow_failure: true

    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@888c2e1ea69ab0d4330cbf0af1ecc7b68f368cc1
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0  # v2
        with:
          key: feature-matrix-ext-${{ matrix.label }}

      - name: "cargo check --workspace (${{ matrix.label }})"
        continue-on-error: ${{ matrix.allow_failure == true }}
        run: cargo check --workspace --locked ${{ matrix.flags }}

  # Per-crate targeted checks for key GPU-surface crates
  gpu-crate-check:
    name: "crate-check (${{ matrix.crate }}/${{ matrix.label }})"
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          - crate: bitnet-kernels
            label: oneapi
            flags: "--no-default-features --features oneapi"
          - crate: bitnet-kernels
            label: gpu+oneapi
            flags: "--no-default-features --features gpu,oneapi"
          - crate: bitnet-device-probe
            label: oneapi
            flags: "--no-default-features --features oneapi"
          - crate: bitnet-device-probe
            label: gpu
            flags: "--no-default-features --features gpu"
          - crate: bitnet-inference
            label: oneapi
            flags: "--no-default-features --features oneapi"
            allow_failure: true
          - crate: bitnet-testing-policy-tests
            label: cpu
            flags: "--no-default-features --features cpu"

    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@888c2e1ea69ab0d4330cbf0af1ecc7b68f368cc1
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0  # v2
        with:
          key: gpu-crate-${{ matrix.crate }}-${{ matrix.label }}

      - name: "cargo check -p ${{ matrix.crate }} (${{ matrix.label }})"
        continue-on-error: ${{ matrix.allow_failure == true }}
        run: cargo check -p ${{ matrix.crate }} --locked ${{ matrix.flags }}
