name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      cpp_tag:
        description: 'Pin C++ (BitNet/llama.cpp) repo tag/commit for crossval/ffi'
        required: false
        default: 'main'
  schedule:
    - cron: "0 3 * * *"  # Daily at 03:00 UTC for nightly CUDA tests

# Cancel in-progress runs when a new commit is pushed to the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-D warnings"
  # Pin C++ version for reproducible crossval - use a specific commit for determinism
  # This is commit 0e6fbf6 from Dec 17, 2024 - update as needed
  CPP_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.cpp_tag || '0e6fbf6d92a7db6a2f44528a41fb1f35d2c223aa' }}
  # CUDA architectures for GPU builds
  CUDA_ARCHS: "80;86"  # A100, RTX 30xx/40xx
  # Git metadata for vergen-gix (works even without .git)
  VERGEN_GIT_SHA: ${{ github.sha }}
  VERGEN_GIT_BRANCH: ${{ github.ref_name }}
  VERGEN_GIT_DESCRIBE: ${{ github.ref_name }}-${{ github.sha }}
  VERGEN_IDEMPOTENT: "1"  # Ensures reproducible builds

jobs:
  # Fast primary test suite - Rust only, no cross-validation
  test:
    name: Test Suite (Rust Primary)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
          # Add ARM64 targets for comprehensive testing
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          targets: ${{ matrix.target }}

      - name: Setup BitNet.cpp Cache (for crossval features)
        if: contains(github.event.pull_request.labels.*.name, 'crossval') || github.ref == 'refs/heads/main'
        run: |
          chmod +x ci/use-bitnet-cpp-cache.sh
          ./ci/use-bitnet-cpp-cache.sh
        shell: bash

      - name: Install cross-compilation tools
        if: matrix.cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install tools (ripgrep, Linux only)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Check formatting
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo fmt --all -- --check

      - name: Run clippy with strict checks
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo clippy --workspace --no-default-features --features cpu --all-targets --exclude xtask --exclude bitnet-py -- -D warnings

      - name: Check banned patterns
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: bash scripts/hooks/banned-patterns.sh

      - name: Check tests compile (CPU only)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: RUSTFLAGS="-Dwarnings" cargo check --workspace --tests --no-default-features --features cpu

      - name: Build (CPU features only)
        run: cargo build --workspace --no-default-features --features cpu

      - name: Run tests (CPU features only)
        run: cargo nextest run --workspace --no-default-features --features cpu --config-file .config/nextest.toml

      - name: Test build without running (CPU only)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo test --workspace --no-default-features --features cpu --no-run

      - name: Build with CPU features
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo build --workspace --no-default-features --features cpu

      - name: Cross-compile (ARM64)
        if: matrix.cross
        run: cross build --target ${{ matrix.target }} --no-default-features --features cpu

  # Feature Matrix Testing - cargo-hack powerset check
  # Non-blocking observability for feature gate consistency
  # See: SPEC-2025-006
  feature-hack-check:
    name: Feature Matrix (cargo-hack powerset)
    runs-on: ubuntu-latest
    needs: [test, feature-matrix]  # Run after primary tests and curated features pass
    continue-on-error: true  # Non-blocking observability
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0

      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install cargo-hack
        run: cargo install cargo-hack --locked

      - name: Check all feature combinations (depth 2)
        run: |
          echo "::group::cargo-hack feature powerset check"
          cargo hack check --feature-powerset --depth 2 \
            --workspace \
            --exclude xtask \
            --exclude bitnet-py \
            --exclude bitnet-wasm \
            --exclude fuzz
          echo "::endgroup::"

      - name: Build all feature combinations (depth 2, lib only)
        run: |
          echo "::group::cargo-hack feature powerset build"
          cargo hack build --feature-powerset --depth 2 \
            --workspace \
            --lib \
            --exclude xtask \
            --exclude bitnet-py \
            --exclude bitnet-wasm \
            --exclude fuzz
          echo "::endgroup::"

  # Feature Matrix Testing - Curated critical feature sets
  # Gates CI - must pass for merge
  # See: SPEC-2025-006
  feature-matrix:
    name: Feature Matrix Tests (curated)
    runs-on: ubuntu-latest
    needs: test  # Run after primary tests pass
    strategy:
      fail-fast: false
      matrix:
        features:
          - cpu
          - cpu,avx2
          - cpu,fixtures
          - cpu,avx2,fixtures
          - ffi
        include:
          # GPU compilation check (no runtime tests)
          - features: gpu
            compile-only: true

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0

      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          key: feature-matrix-${{ matrix.features }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Build (${{ matrix.features }})
        run: |
          echo "::group::Build with features: ${{ matrix.features }}"
          cargo build --workspace --no-default-features --features "${{ matrix.features }}"
          echo "::endgroup::"

      - name: Run tests (${{ matrix.features }})
        if: matrix.compile-only != true
        run: |
          echo "::group::Test with features: ${{ matrix.features }}"

          # Select nextest profile based on features
          PROFILE="ci"
          if [[ "${{ matrix.features }}" == *"fixtures"* ]]; then
            PROFILE="fixtures"
          fi

          cargo nextest run --workspace \
            --no-default-features \
            --features "${{ matrix.features }}" \
            --profile "$PROFILE"
          echo "::endgroup::"

      - name: Run doctests (${{ matrix.features }})
        if: matrix.compile-only != true
        run: |
          echo "::group::Doctests with features: ${{ matrix.features }}"
          cargo test --doc --workspace \
            --no-default-features \
            --features "${{ matrix.features }}"
          echo "::endgroup::"

  # Doctest Feature Matrix - Validate documentation examples
  # Gates CI - must pass for merge
  # See: SPEC-2025-006
  doctest-matrix:
    name: Doctests (Feature Matrix)
    runs-on: ubuntu-latest
    needs: test  # Run after primary tests pass
    strategy:
      fail-fast: false
      matrix:
        features:
          - cpu
          - cpu,avx2
          - all-features

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0

      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Run doctests (${{ matrix.features }})
        run: |
          echo "::group::Doctests with ${{ matrix.features }}"

          if [[ "${{ matrix.features }}" == "all-features" ]]; then
            cargo test --doc --workspace --all-features
          else
            cargo test --doc --workspace --no-default-features --features "${{ matrix.features }}"
          fi

          echo "::endgroup::"
        # Continue on error for all-features (GPU may not be available)
        continue-on-error: ${{ matrix.features == 'all-features' }}

  # Guard: Fixture Integrity Validator
  # Validates fixture checksums, schema, and alignment
  # See: SPEC-2025-006
  # Independent gate - runs in parallel with test
  guard-fixture-integrity:
    name: Guard - Fixture Integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Validate fixture integrity
        run: bash scripts/validate-fixtures.sh

  # Guard: Serial Annotation Validator
  # Ensures env-mutating tests have #[serial(bitnet_env)]
  # See: SPEC-2025-006
  # Independent gate - runs in parallel with test
  guard-serial-annotations:
    name: Guard - Serial Annotations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Check serial annotations
        run: bash scripts/check-serial-annotations.sh

  # Guard: Feature Gate Consistency Checker
  # Cross-checks #[cfg(feature = "...")] with defined features
  # See: SPEC-2025-006
  # Independent gate - runs in parallel with test
  guard-feature-consistency:
    name: Guard - Feature Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Check feature gate consistency
        run: bash scripts/check-feature-gates.sh

  # Guard: Unannotated Ignore Detector
  # Ensures all #[ignore] tests have issue references or justification
  # See: SPEC-2025-006
  # Status: 144 total ignores, all properly annotated (122 inline comments, 22 preceding comments)
  # Independent gate - runs in parallel with test
  guard-ignore-annotations:
    name: Guard - Ignore Annotations
    runs-on: ubuntu-latest
    # BLOCKING: All #[ignore] attributes must have justification
    steps:
      - uses: actions/checkout@v4

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Check ignore annotations
        run: bash scripts/check-ignore-annotations.sh

  # Doctest validation - ensures code examples in documentation are correct
  doctest:
    name: Doctests (CPU)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Run doctests (CPU features only)
        run: cargo test --doc --workspace --no-default-features --features cpu

      - name: Run doctests (all features)
        # Continue on error since GPU features may not be available in CI
        continue-on-error: true
        run: cargo test --doc --workspace --all-features

  # Performance smoke test (non-gating observability)
  perf-smoke:
    name: Performance Smoke Test (observability)
    runs-on: ubuntu-latest
    needs: [test]
    # Run on all events to track performance across branches
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Download test model
        run: |
          cargo run -p xtask -- download-model

      - name: Build CLI (release)
        run: |
          cargo build --release -p bitnet-cli --no-default-features --features cpu,full-cli

      - name: Perf smoke (non-gating)
        # Non-gating: observability only for elapsed time tracking
        # Based on ci/exploration/PR3_perf_receipts_plan.md
        continue-on-error: true
        env:
          BITNET_DETERMINISTIC: "1"
          RAYON_NUM_THREADS: "1"
          RUST_LOG: warn
        run: |
          echo "::group::Perf smoke test with /usr/bin/time (non-gating)"
          echo "Running deterministic 4-token inference with timing..."

          # Run inference with /usr/bin/time to capture elapsed time
          /usr/bin/time -v target/release/bitnet-cli run \
            --model models/microsoft-bitnet-b1.58-2B-4T-gguf/ggml-model-i2_s.gguf \
            --tokenizer models/microsoft-bitnet-b1.58-2B-4T-gguf/tokenizer.json \
            --prompt "2+2=" \
            --max-tokens 4 \
            --temperature 0 --greedy || {
              echo "::notice::Perf smoke test failed (non-gating, for observability only)"
              true
            }

          echo "::endgroup::"

      - name: Performance smoke test (4-token inference)
        # Non-gating: continue even if this step fails
        # Purpose: Observability for major performance regressions (not a quality gate)
        # This provides visibility into performance changes without blocking CI
        continue-on-error: true
        env:
          RUST_LOG: warn
          BITNET_DETERMINISTIC: "1"
          BITNET_SEED: "42"
          RAYON_NUM_THREADS: "1"
        run: |
          echo "::group::Running performance smoke test with receipt generation"
          echo "Note: This test is non-gating and provides performance observability only"
          echo "It helps detect major regressions but won't fail the build"
          echo ""

          # Create ci directory for receipts
          mkdir -p ci

          # Run benchmark with receipt generation
          cargo run -p xtask --release -- benchmark \
            --model models/microsoft-bitnet-b1.58-2B-4T-gguf/ggml-model-i2_s.gguf \
            --tokens 4 || {
              echo "::warning::Benchmark failed, falling back to mock (non-gating)"
              exit 0
            }

          echo ""
          echo "Performance smoke test completed - receipt generated at ci/inference.json"
          echo "::endgroup::"

      - name: Verify positive receipt example
        continue-on-error: true
        run: |
          echo "::group::Verifying positive receipt example"
          cargo run -p xtask --release -- verify-receipt \
            --path docs/tdd/receipts/cpu_positive_example.json && {
              echo "âœ… Positive receipt verification passed"
            } || {
              echo "::error::Positive receipt verification failed - this should always pass"
              exit 1
            }
          echo "::endgroup::"

      - name: Verify negative receipt example (should fail)
        continue-on-error: true
        run: |
          echo "::group::Verifying negative receipt example (expecting failure)"
          ! cargo run -p xtask --release -- verify-receipt \
            --path docs/tdd/receipts/cpu_negative_example.json && {
              echo "âœ… Negative receipt correctly rejected"
            } || {
              echo "::error::Negative receipt verification passed - it should have failed"
              exit 1
            }
          echo "::endgroup::"

      - name: Verify generated receipt
        if: hashFiles('ci/inference.json') != ''
        continue-on-error: true
        run: |
          echo "::group::Verifying generated inference receipt"
          cargo run -p xtask --release -- verify-receipt \
            --path ci/inference.json || {
              echo "::warning::Generated receipt verification failed (non-gating)"
              exit 0
            }
          echo "âœ… Generated receipt verification passed"
          echo "::endgroup::"

      - name: Comment performance results (PR only)
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let receipt = {};
            let receiptDetails = '';

            // Try to read generated receipt
            try {
              if (fs.existsSync('ci/inference.json')) {
                receipt = JSON.parse(fs.readFileSync('ci/inference.json', 'utf8'));
                receiptDetails = `
            **Performance**: ${receipt.tokens_per_second ? receipt.tokens_per_second.toFixed(2) : 'N/A'} tok/s
            **Kernels**: ${receipt.kernels ? receipt.kernels.length : 'N/A'} executed
            **Backend**: ${receipt.backend || 'N/A'}
            **Receipt Status**: âœ… Verified (compute_path=${receipt.compute_path || 'unknown'})
            `;
              }
            } catch (e) {
              console.log('Could not read receipt:', e);
              receiptDetails = '\n**Receipt**: Not available (benchmark may have failed)\n';
            }

            const comment = `## ðŸ” Performance Smoke Test (Observability)

            **Status**: âœ… Non-gating (informational only)
            **Configuration**: 4 tokens, greedy decode, CPU inference
            **Model**: microsoft-bitnet-b1.58-2B-4T-gguf (I2_S)
            ${receiptDetails}
            This test provides visibility into performance changes without blocking merges.
            For detailed analysis, see the artifact: \`inference-receipt-${{ github.sha }}.json\`
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload receipt artifact
        if: always() && hashFiles('ci/inference.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: inference-receipt-${{ github.sha }}
          path: ci/inference.json
          retention-days: 30

  # Environment mutation guard - ensures tests use EnvGuard pattern
  # Independent gate - runs in parallel with test
  env-mutation-guard:
    name: Guard - No raw env mutations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Check for raw env mutations
        run: |
          offenders=$(rg -n '(std::env::set_var|std::env::remove_var)\(' crates \
            --glob '!**/tests/support/**' \
            --glob '!**/support/**' \
            --glob '!**/helpers/**' \
            --glob '!**/test_fixtures/**' \
            --type rust || true)
          if [ -n "$offenders" ]; then
            echo "::error::Raw env mutation detected. Use EnvGuard + #[serial(bitnet_env)]."
            echo ""
            echo "Offending locations:"
            echo "$offenders"
            echo ""
            echo "See tests/support/env_guard.rs for proper usage patterns."
            exit 1
          fi
          echo "âœ… No raw env mutations detected - all tests use EnvGuard pattern"

  # API compatibility and semver checking
  # Observer - runs after primary tests, non-blocking
  api-compat:
    name: API Compatibility Check
    runs-on: ubuntu-latest
    needs: [test]  # Run after primary tests pass
    continue-on-error: true  # Non-blocking observability
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for baseline comparison

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0

      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install tools
        run: |
          cargo install cargo-semver-checks --locked || true
          cargo install cargo-public-api --locked || true
          cargo install cbindgen --locked || true
          sudo apt-get update && sudo apt-get install -y jq binutils

      # Semver breaking check
      - name: Semver breaking detection
        run: |
          BASE="${{ github.base_ref || 'main' }}"
          echo "Checking against base branch: $BASE"
          cargo run -p xtask -- detect-breaking \
            --baseline origin/$BASE \
            --current . \
            --format json || echo "::warning::Breaking changes detected"

      # Rust public API diffs
      - name: Rust public API diffs
        run: |
          set -eu
          echo "Checking Rust public API compatibility..."
          for CR in bitnet-common bitnet-kernels bitnet-inference bitnet-ffi bitnet-cli; do
            echo "Checking $CR..."
            cargo public-api -p $CR > target/$CR.public-api.txt || true
            if [ -f "api/rust/$CR.public-api.txt" ]; then
              diff -u api/rust/$CR.public-api.txt target/$CR.public-api.txt || {
                echo "::warning::API changes detected in $CR"
              }
            fi
          done

      # FFI header diff
      - name: FFI header diff
        run: |
          if [ -f "api/ffi/cbindgen.toml" ]; then
            cbindgen crates/bitnet-ffi --config api/ffi/cbindgen.toml -o target/bitnet_ffi.h || true
            diff -u api/ffi/bitnet_ffi.h target/bitnet_ffi.h || {
              echo "::warning::FFI header changes detected"
            }
          fi

      # FFI symbols diff (Linux)
      - name: FFI symbols diff
        run: |
          cargo build -p bitnet-ffi --release --no-default-features --features ffi || true
          if [ -f "target/release/libbitnet_ffi.so" ]; then
            nm -D --defined-only target/release/libbitnet_ffi.so | awk '{print $3}' | sort > target/ffi.symbols.txt || true
            if [ -f "api/ffi/ffi.symbols.txt" ]; then
              diff -u api/ffi/ffi.symbols.txt target/ffi.symbols.txt || {
                echo "::warning::FFI symbol changes detected"
              }
            fi
          fi

      # CLI contract diffs
      - name: CLI help diff
        run: |
          cargo build -p bitnet-cli --release --no-default-features --features cpu || true
          if [ -f "target/release/bitnet-cli" ]; then
            ./target/release/bitnet-cli --help > target/help.txt || true
            if [ -f "api/cli/help.txt" ]; then
              diff -u api/cli/help.txt target/help.txt || {
                echo "::warning::CLI help text changed"
              }
            fi
          fi

      # Snapshot tests
      - name: API snapshot tests
        run: |
          cargo test --test api_snapshots || echo "::warning::Snapshot tests failed"

      - name: Generate compatibility report
        if: always()
        run: |
          echo '{"timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "status": "checked"}' > api-compatibility-report.json

      - name: Upload compatibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-compatibility-report
          path: api-compatibility-report.json

  # Security audit - independent gate, runs in parallel with test
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-deny advisory DB
        uses: actions/cache@v4
        with:
          path: ~/.cargo/advisory-db
          key: advisory-db-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            advisory-db-${{ runner.os }}-
            advisory-db-

      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        run: cargo audit
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked || true
      - name: Run cargo-deny
        run: cargo deny check --hide-inclusion-graph

  # FFI smoke build to ensure native paths stay healthy
  ffi-smoke:
    name: FFI Smoke Build (${{ matrix.cc }})
    runs-on: ubuntu-latest
    needs: [test]  # Run after primary tests pass
    strategy:
      matrix:
        include:
          - cc: gcc
            cxx: g++
          - cc: clang
            cxx: clang++
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install native toolchain deps
        run: sudo apt-get update && sudo apt-get install -y clang make gcc g++
      - name: Smoke build (ffi only, no tests)
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          cargo build --workspace --no-default-features --features ffi --exclude bitnet-sys --exclude crossval
          cargo test  --workspace --no-default-features --features ffi --exclude bitnet-sys --exclude crossval --no-run

  ffi-zero-warning-windows:
    name: FFI Â· zero warnings (MSVC)
    runs-on: windows-latest
    needs: [test]  # Run after primary tests pass
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build FFI with MSVC (fail on warnings)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $output = & cargo build -p bitnet-ggml-ffi --no-default-features --features iq2s-ffi 2>&1 | Out-String
          Write-Output $output
          # Match MSVC-specific warning patterns: "warning:" or "warning C####"
          if ($output -match '(?i)\bwarning([ :]| C\d{4}\b)') {
            throw "FFI build produced warnings on MSVC"
          }
          Write-Output "âœ… FFI build completed with zero warnings on MSVC"

  ffi-zero-warning-linux:
    name: FFI Â· zero warnings (Linux ${{ matrix.cc }})
    runs-on: ubuntu-latest
    needs: [test]  # Run after primary tests pass
    strategy:
      matrix:
        include:
          - cc: gcc
            cxx: g++
          - cc: clang
            cxx: clang++
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install native toolchain
        run: sudo apt-get update && sudo apt-get install -y clang make gcc g++
      - name: Build FFI with ${{ matrix.cc }} (fail on warnings)
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          set -o pipefail
          cargo build -p bitnet-ggml-ffi --no-default-features --features iq2s-ffi 2>&1 | tee /tmp/build.log
          if grep -q "warning:" /tmp/build.log; then
            echo "::error::FFI build produced warnings with ${{ matrix.cc }}"
            exit 1
          fi
          echo "âœ… FFI build completed with zero warnings on ${{ matrix.cc }}"

  # Performance benchmarks - observer, runs after primary tests on main branch only
  benchmark:
    name: Performance Benchmarks (Rust)
    runs-on: ubuntu-latest
    needs: [test]  # Run after primary tests pass
    continue-on-error: true  # Non-blocking observability
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Run Rust benchmarks (no crossval)
        run: cargo bench --workspace --features "cpu,gpu,avx2"
      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: "cargo"
          output-file-path: target/criterion/report/index.html
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          comment-on-alert: true
          alert-threshold: "105%" # Alert if 5% slower

  # Code quality checks - gate, runs in parallel with test
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-quality-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo tools
        run: |
          cargo install cargo-llvm-cov cargo-machete cargo-outdated

      - name: Check for unused dependencies
        run: cargo machete

      - name: Check for outdated dependencies
        run: cargo outdated --exit-code 1
        continue-on-error: true

      - name: Generate coverage report
        run: cargo llvm-cov --workspace --features cpu --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: lcov.info
          fail_ci_if_error: false # Don't fail CI on coverage upload issues

      - name: Check documentation
        run: cargo doc --workspace --features cpu --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: "-D warnings"

      # Markdown quality checks
      - name: Markdownlint
        run: npx --yes markdownlint-cli "**/*.md" "!target/**" "!vendor/**"

      # Link validation (offline mode for CI performance)
      - name: Check links
        run: |
          cargo install lychee || true
          lychee --accept 200,429 --no-progress --offline --config .lychee.toml "**/*.md"

  # Cross-validation with C++ (CPU)
  crossval-cpu:
    name: Cross-validation (CPU)
    needs: [test]
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    # Hard gate: fail the job on errors
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          cache-targets: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Cache BitNet C++ (CPU)
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: bitnet-cpp-${{ runner.os }}-cpu-${{ env.CPP_TAG }}
          restore-keys: |
            bitnet-cpp-${{ runner.os }}-cpu-

      - name: Fetch & build C++ (CPU)
        run: cargo run -p xtask -- fetch-cpp --tag "${CPP_TAG}"

      - name: Build (cpu,ffi,crossval)
        run: cargo build --workspace --no-default-features --features "cpu,ffi,crossval"

      - name: Run full crossval (CPU)
        run: cargo run -p xtask -- full-crossval --tag "${CPP_TAG}"

      - name: Validate model vocab matches lock
        shell: bash
        run: |
          set -euo pipefail
          EXP=$(jq -r '.crossval_default.n_vocab' crossval-models.lock.json)
          GOT=$(jq -r '.model.vocab' crossval/results/last_run.json || echo "0")
          if [ "$EXP" != "$GOT" ]; then
            echo "::error::Vocab mismatch: expected $EXP, got $GOT"
            exit 1
          fi
          echo "âœ“ Vocab validated: $GOT matches expected $EXP"

      - name: Upload crossval artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crossval-cpu-${{ env.CPP_TAG }}
          path: |
            crossval/**/results/**/*.json
            crossval/**/reports/**/*.{md,html,txt}
            models/*.gguf

  # CUDA build and test (requires GPU runner)
  build-test-cuda:
    name: Build & Test (CUDA)
    needs: [test]
    runs-on: [self-hosted, linux, x64, gpu]  # GPU runner labels
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    # Hard gate: fail the job on errors
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          cache-targets: true

      - name: Verify GPU visibility
        run: |
          nvidia-smi
          echo "CUDA_HOME=${CUDA_HOME:-/usr/local/cuda}"
          ls -l ${CUDA_HOME:-/usr/local/cuda}/lib64 || true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Cache BitNet C++ (CUDA)
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: bitnet-cpp-${{ runner.os }}-cuda-${{ env.CPP_TAG }}-${{ env.CUDA_ARCHS }}
          restore-keys: |
            bitnet-cpp-${{ runner.os }}-cuda-

      - name: Build workspace (cuda)
        run: cargo build --workspace --no-default-features --features cuda

      - name: Test kernels (CUDA)
        run: cargo test -p bitnet-kernels --no-default-features --features cuda --tests -- --nocapture

      - name: Run CUDA smoke test
        run: cargo run -p bitnet-kernels --example cuda_smoke --no-default-features --features cuda

  # Full cross-validation with CUDA
  crossval-cuda:
    name: Cross-validation (CUDA)
    needs: [test]
    runs-on: [self-hosted, linux, x64, gpu]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    # Hard gate: fail the job on errors
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          cache-targets: true

      - name: Verify GPU
        run: nvidia-smi

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Cache BitNet C++ (CUDA)
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: bitnet-cpp-${{ runner.os }}-cuda-${{ env.CPP_TAG }}-${{ env.CUDA_ARCHS }}
          restore-keys: |
            bitnet-cpp-${{ runner.os }}-cuda-

      - name: Fetch & build C++ (CUDA)
        run: |
          cargo run -p xtask -- fetch-cpp --tag "${CPP_TAG}" \
            --backend cuda --cmake-flags "-DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHS}"

      - name: Build (cuda,ffi,crossval)
        run: cargo build --workspace --no-default-features --features "cuda,ffi,crossval"

      - name: Run full crossval (CUDA)
        run: |
          cargo run -p xtask -- full-crossval --tag "${CPP_TAG}" \
            --backend cuda --cmake-flags "-DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHS}"

      - name: Validate model vocab matches lock
        shell: bash
        run: |
          set -euo pipefail
          EXP=$(jq -r '.crossval_default.n_vocab' crossval-models.lock.json)
          GOT=$(jq -r '.model.vocab' crossval/results/last_run.json || echo "0")
          if [ "$EXP" != "$GOT" ]; then
            echo "::error::Vocab mismatch: expected $EXP, got $GOT"
            exit 1
          fi
          echo "âœ“ Vocab validated: $GOT matches expected $EXP"

      - name: Upload crossval artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crossval-cuda-${{ env.CPP_TAG }}
          path: |
            crossval/**/results/**/*.json
            crossval/**/reports/**/*.{md,html,txt}
            crossval/**/logs/**/*.log
            models/*.gguf

      - name: Compare metrics with baseline
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail
          test -f baselines/cuda-main.json
          cargo run -p xtask -- compare-metrics \
            --baseline baselines/cuda-main.json \
            --current crossval/results/last_run.json \
            --ppl-max 0.02 --latency-p95-max 0.05 --tok-s-min -0.05

  # Fast smoke test for cross-validation (required for PRs)
  crossval-cpu-smoke:
    name: Cross-validation (CPU, smoke)
    needs: [test]
    runs-on: ubuntu-22.04
    env:
      # Use the global CPP_TAG which is already pinned to a specific commit
      RUST_BACKTRACE: 1
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          cache-targets: true

      - name: Install deps
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential cmake

      - name: Cache BitNet C++ (smoke)
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: bitnet-cpp-${{ runner.os }}-smoke-${{ env.CPP_TAG }}
          restore-keys: |
            bitnet-cpp-${{ runner.os }}-

      - name: Fetch C++ (pinned)
        run: |
          cargo run -p xtask -- fetch-cpp --tag "${CPP_TAG}"

      - name: Download test model
        run: |
          cargo run -p xtask -- download-model

      - name: Verify model lock
        run: |
          # Verify the model matches expected SHA
          MODEL_SHA=$(sha256sum models/microsoft-bitnet-b1.58-2B-4T-gguf/ggml-model-i2_s.gguf | cut -d' ' -f1)
          EXPECTED_SHA=$(jq -r '.crossval_default.sha256' crossval-models.lock.json)
          if [ "$MODEL_SHA" != "$EXPECTED_SHA" ]; then
            echo "Model SHA mismatch: $MODEL_SHA != $EXPECTED_SHA"
            exit 1
          fi

      - name: Run smoke tests (parity preflight + tiny checks)
        env:
          CROSSVAL_GGUF: models/microsoft-bitnet-b1.58-2B-4T-gguf/ggml-model-i2_s.gguf
          OMP_NUM_THREADS: 1
          GGML_NUM_THREADS: 1
          MKL_NUM_THREADS: 1
          OPENBLAS_NUM_THREADS: 1
        run: |
          # Prepare dynamic loader search paths at runtime
          echo "BITNET_CPP_DIR=$HOME/.cache/bitnet_cpp" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=$HOME/.cache/bitnet_cpp/build/3rdparty/llama.cpp/src:$HOME/.cache/bitnet_cpp/build/3rdparty/llama.cpp/ggml/src:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

          # Build with crossval support
          cargo build --workspace --no-default-features --features "cpu,ffi,crossval"

          # Run smoke tests from the dedicated smoke.rs file
          cargo test -p bitnet-crossval --test smoke -- --ignored --nocapture

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crossval-smoke-${{ github.sha }}
          path: |
            crossval/**/results/**/*.json
            crossval/**/logs/**/*.log
