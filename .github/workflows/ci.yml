name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      cpp_tag:
        description: 'Pin C++ (BitNet/llama.cpp) repo tag/commit for crossval/ffi'
        required: false
        default: 'main'
  schedule:
    - cron: "0 3 * * *"  # Daily at 03:00 UTC for nightly CUDA tests

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-D warnings"
  # Pin C++ version for reproducible crossval
  CPP_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.cpp_tag || 'main' }}
  # CUDA architectures for GPU builds
  CUDA_ARCHS: "80;86"  # A100, RTX 30xx/40xx

jobs:
  # Fast primary test suite - Rust only, no cross-validation
  test:
    name: Test Suite (Rust Primary)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
          # Add ARM64 targets for comprehensive testing
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          targets: ${{ matrix.target }}

      - name: Setup BitNet.cpp Cache (for crossval features)
        if: contains(github.event.pull_request.labels.*.name, 'crossval') || github.ref == 'refs/heads/main'
        run: |
          chmod +x ci/use-bitnet-cpp-cache.sh
          ./ci/use-bitnet-cpp-cache.sh
        shell: bash

      - name: Install cross-compilation tools
        if: matrix.cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install tools (ripgrep)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Check formatting
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo fmt --all -- --check

      - name: Run clippy with strict checks
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo clippy --workspace --no-default-features --features cpu --all-targets --exclude xtask --exclude bitnet-py -- -D warnings

      - name: Check banned patterns
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: bash scripts/hooks/banned-patterns.sh

      - name: Check tests compile (CPU only)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: RUSTFLAGS="-Dwarnings" cargo check --workspace --tests --no-default-features --features cpu

      - name: Build (CPU features only)
        run: cargo build --workspace --no-default-features --features cpu

      - name: Run tests (CPU features only)
        run: cargo test --workspace --no-default-features --features cpu

      - name: Test build without running (CPU only)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo test --workspace --no-default-features --features cpu --no-run

      - name: Build with CPU features
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo build --workspace --no-default-features --features cpu

      - name: Cross-compile (ARM64)
        if: matrix.cross
        run: cross build --target ${{ matrix.target }} --no-default-features --features cpu

  # API compatibility and semver checking
  api-compat:
    name: API Compatibility Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for baseline comparison
      
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
      
      - name: Install tools
        run: |
          cargo install cargo-semver-checks --locked || true
          cargo install cargo-public-api --locked || true
          cargo install cbindgen --locked || true
          sudo apt-get update && sudo apt-get install -y jq binutils
      
      # Semver breaking check
      - name: Semver breaking detection
        run: |
          BASE="${{ github.base_ref || 'main' }}"
          echo "Checking against base branch: $BASE"
          cargo run -p xtask -- detect-breaking \
            --baseline origin/$BASE \
            --current . \
            --format json || echo "::warning::Breaking changes detected"
      
      # Rust public API diffs
      - name: Rust public API diffs
        run: |
          set -eu
          echo "Checking Rust public API compatibility..."
          for CR in bitnet-common bitnet-kernels bitnet-inference bitnet-ffi bitnet-cli; do
            echo "Checking $CR..."
            cargo public-api -p $CR > target/$CR.public-api.txt || true
            if [ -f "api/rust/$CR.public-api.txt" ]; then
              diff -u api/rust/$CR.public-api.txt target/$CR.public-api.txt || {
                echo "::warning::API changes detected in $CR"
              }
            fi
          done
      
      # FFI header diff
      - name: FFI header diff
        run: |
          if [ -f "api/ffi/cbindgen.toml" ]; then
            cbindgen crates/bitnet-ffi --config api/ffi/cbindgen.toml -o target/bitnet_ffi.h || true
            diff -u api/ffi/bitnet_ffi.h target/bitnet_ffi.h || {
              echo "::warning::FFI header changes detected"
            }
          fi
      
      # FFI symbols diff (Linux)
      - name: FFI symbols diff
        run: |
          cargo build -p bitnet-ffi --release --no-default-features --features ffi || true
          if [ -f "target/release/libbitnet_ffi.so" ]; then
            nm -D --defined-only target/release/libbitnet_ffi.so | awk '{print $3}' | sort > target/ffi.symbols.txt || true
            if [ -f "api/ffi/ffi.symbols.txt" ]; then
              diff -u api/ffi/ffi.symbols.txt target/ffi.symbols.txt || {
                echo "::warning::FFI symbol changes detected"
              }
            fi
          fi
      
      # CLI contract diffs
      - name: CLI help diff
        run: |
          cargo build -p bitnet-cli --release --no-default-features --features cpu || true
          if [ -f "target/release/bitnet-cli" ]; then
            ./target/release/bitnet-cli --help > target/help.txt || true
            if [ -f "api/cli/help.txt" ]; then
              diff -u api/cli/help.txt target/help.txt || {
                echo "::warning::CLI help text changed"
              }
            fi
          fi
      
      # Snapshot tests
      - name: API snapshot tests
        run: |
          cargo test --test api_snapshots || echo "::warning::Snapshot tests failed"
      
      - name: Generate compatibility report
        if: always()
        run: |
          echo '{"timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "status": "checked"}' > api-compatibility-report.json
      
      - name: Upload compatibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-compatibility-report
          path: api-compatibility-report.json

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-deny advisory DB
        uses: actions/cache@v4
        with:
          path: ~/.cargo/advisory-db
          key: advisory-db-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            advisory-db-${{ runner.os }}-
            advisory-db-

      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        run: cargo audit
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked || true
      - name: Run cargo-deny
        run: cargo deny check --hide-inclusion-graph

  # FFI smoke build to ensure native paths stay healthy
  ffi-smoke:
    name: FFI Smoke Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install native toolchain deps
        run: sudo apt-get update && sudo apt-get install -y clang make gcc g++
      - name: Smoke build (ffi only, no tests)
        run: |
          cargo build --workspace --no-default-features --features ffi --exclude bitnet-sys --exclude crossval
          cargo test  --workspace --no-default-features --features ffi --exclude bitnet-sys --exclude crossval --no-run

  benchmark:
    name: Performance Benchmarks (Rust)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Run Rust benchmarks (no crossval)
        run: cargo bench --workspace --features "cpu,gpu,avx2"
      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: "cargo"
          output-file-path: target/criterion/report/index.html
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          comment-on-alert: true
          alert-threshold: "105%" # Alert if 5% slower

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-quality-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo tools
        run: |
          cargo install cargo-llvm-cov cargo-machete cargo-outdated

      - name: Check for unused dependencies
        run: cargo machete

      - name: Check for outdated dependencies
        run: cargo outdated --exit-code 1
        continue-on-error: true

      - name: Generate coverage report
        run: cargo llvm-cov --workspace --features cpu --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: lcov.info
          fail_ci_if_error: false # Don't fail CI on coverage upload issues

      - name: Check documentation
        run: cargo doc --workspace --features cpu --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: "-D warnings"

  # Cross-validation with C++ (CPU)
  crossval-cpu:
    name: Cross-validation (CPU)
    needs: [test]
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          cache-targets: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Cache BitNet C++ (CPU)
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: bitnet-cpp-${{ runner.os }}-cpu-${{ env.CPP_TAG }}
          restore-keys: |
            bitnet-cpp-${{ runner.os }}-cpu-

      - name: Fetch & build C++ (CPU)
        run: cargo run -p xtask -- fetch-cpp --tag "${CPP_TAG}"

      - name: Build (cpu,ffi,crossval)
        run: cargo build --workspace --no-default-features --features "cpu,ffi,crossval"

      - name: Run full crossval (CPU)
        run: cargo run -p xtask -- full-crossval --tag "${CPP_TAG}"

      - name: Upload crossval artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crossval-cpu-${{ env.CPP_TAG }}
          path: |
            crossval/**/results/**/*.json
            crossval/**/reports/**/*.{md,html,txt}
            models/*.gguf

  # CUDA build and test (requires GPU runner)
  build-test-cuda:
    name: Build & Test (CUDA)
    needs: [test]
    runs-on: [self-hosted, linux, x64, gpu]  # GPU runner labels
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    continue-on-error: true  # Remove when GPU infra is stable
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          cache-targets: true

      - name: Verify GPU visibility
        run: |
          nvidia-smi
          echo "CUDA_HOME=${CUDA_HOME:-/usr/local/cuda}"
          ls -l ${CUDA_HOME:-/usr/local/cuda}/lib64 || true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Cache BitNet C++ (CUDA)
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: bitnet-cpp-${{ runner.os }}-cuda-${{ env.CPP_TAG }}-${{ env.CUDA_ARCHS }}
          restore-keys: |
            bitnet-cpp-${{ runner.os }}-cuda-

      - name: Build workspace (cuda)
        run: cargo build --workspace --no-default-features --features cuda

      - name: Test kernels (CUDA)
        run: cargo test -p bitnet-kernels --no-default-features --features cuda --tests -- --nocapture

      - name: Run CUDA smoke test
        run: cargo run -p bitnet-kernels --example cuda_smoke --no-default-features --features cuda

  # Full cross-validation with CUDA
  crossval-cuda:
    name: Cross-validation (CUDA)
    needs: [test]
    runs-on: [self-hosted, linux, x64, gpu]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
      - uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          cache-targets: true

      - name: Verify GPU
        run: nvidia-smi

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Cache BitNet C++ (CUDA)
        uses: actions/cache@v4
        with:
          path: ~/.cache/bitnet_cpp
          key: bitnet-cpp-${{ runner.os }}-cuda-${{ env.CPP_TAG }}-${{ env.CUDA_ARCHS }}
          restore-keys: |
            bitnet-cpp-${{ runner.os }}-cuda-

      - name: Fetch & build C++ (CUDA)
        run: |
          cargo run -p xtask -- fetch-cpp --tag "${CPP_TAG}" \
            --backend cuda --cmake-flags "-DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHS}"

      - name: Build (cuda,ffi,crossval)
        run: cargo build --workspace --no-default-features --features "cuda,ffi,crossval"

      - name: Run full crossval (CUDA)
        run: |
          cargo run -p xtask -- full-crossval --tag "${CPP_TAG}" \
            --backend cuda --cmake-flags "-DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHS}"

      - name: Upload crossval artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crossval-cuda-${{ env.CPP_TAG }}
          path: |
            crossval/**/results/**/*.json
            crossval/**/reports/**/*.{md,html,txt}
            crossval/**/logs/**/*.log
            models/*.gguf

      - name: Compare metrics with baseline
        if: github.ref == 'refs/heads/main'
        run: |
          if [ -f "baselines/cuda-main.json" ]; then
            cargo run -p xtask -- compare-metrics \
              --baseline baselines/cuda-main.json \
              --current crossval/results/last_run.json \
              --ppl-max 0.02 --latency-p95-max 0.05 --tok-s-min -0.05
          fi
        continue-on-error: true
