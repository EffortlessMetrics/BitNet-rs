name: Testing Framework - Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "tests/**"
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/testing-framework-integration.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "tests/**"
      - "crates/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/testing-framework-integration.yml"
  schedule:
    # Run integration tests nightly
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      test_timeout:
        description: "Test timeout in minutes"
        required: false
        default: "30"
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  TEST_TIMEOUT: ${{ github.event.inputs.test_timeout || '30' }}

jobs:
  integration-tests:
    name: Integration Tests (${{ matrix.test_suite }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        test_suite:
          - workflow-integration
          - component-interaction
          - configuration-testing
          - resource-management
        include:
          - os: ubuntu-latest
            features: "cpu,avx2"
          - os: windows-latest
            features: "cpu,avx2"
          - os: macos-latest
            features: "cpu,neon"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-integration-${{ matrix.test_suite }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-integration-${{ matrix.test_suite }}-
            ${{ runner.os }}-integration-

      - name: Install testing tools
        run: |
          cargo install cargo-nextest --locked

      - name: Setup test environment
        run: |
          echo "Setting up integration test environment..."

          # Create test directories
          mkdir -p tests/cache
          mkdir -p tests/artifacts
          mkdir -p tests/logs

          # Set environment variables
          echo "BITNET_TEST_CACHE=$(pwd)/tests/cache" >> $GITHUB_ENV
          echo "BITNET_TEST_ARTIFACTS=$(pwd)/tests/artifacts" >> $GITHUB_ENV
          echo "BITNET_TEST_LOGS=$(pwd)/tests/logs" >> $GITHUB_ENV
          echo "BITNET_TEST_TIMEOUT=${TEST_TIMEOUT}m" >> $GITHUB_ENV

      - name: Download test fixtures
        run: |
          echo "Setting up test fixtures for ${{ matrix.test_suite }}..."

          # Create minimal test models and data
          cat > tests/cache/test-model-small.json << 'EOF'
          {
            "model_type": "bitnet",
            "vocab_size": 1000,
            "hidden_size": 256,
            "num_layers": 4,
            "test_fixture": true
          }
          EOF

          cat > tests/cache/test-prompts.json << 'EOF'
          {
            "prompts": [
              "Hello, world!",
              "The quick brown fox jumps over the lazy dog.",
              "In a hole in the ground there lived a hobbit."
            ]
          }
          EOF

          echo "Test fixtures created"

      - name: Run workflow integration tests
        if: matrix.test_suite == 'workflow-integration'
        run: |
          echo "Running workflow integration tests..."
          cargo nextest run \
            --workspace \
            --features "${{ matrix.features }}" \
            --test-threads 1 \
            --timeout ${TEST_TIMEOUT}m \
            -E 'test(workflow_integration)' \
            -- --nocapture

      - name: Run component interaction tests
        if: matrix.test_suite == 'component-interaction'
        run: |
          echo "Running component interaction tests..."
          cargo nextest run \
            --workspace \
            --features "${{ matrix.features }}" \
            --test-threads 1 \
            --timeout ${TEST_TIMEOUT}m \
            -E 'test(component_interaction)' \
            -- --nocapture

      - name: Run configuration testing
        if: matrix.test_suite == 'configuration-testing'
        run: |
          echo "Running configuration tests..."
          cargo nextest run \
            --workspace \
            --features "${{ matrix.features }}" \
            --test-threads 1 \
            --timeout ${TEST_TIMEOUT}m \
            -E 'test(configuration)' \
            -- --nocapture

      - name: Run resource management tests
        if: matrix.test_suite == 'resource-management'
        run: |
          echo "Running resource management tests..."
          cargo nextest run \
            --workspace \
            --features "${{ matrix.features }}" \
            --test-threads 1 \
            --timeout ${TEST_TIMEOUT}m \
            -E 'test(resource_management)' \
            -- --nocapture

      - name: Collect test artifacts
        if: always()
        run: |
          echo "Collecting test artifacts..."

          # Create artifact directory structure
          mkdir -p integration-artifacts/${{ matrix.test_suite }}-${{ matrix.os }}

          # Copy logs
          if [[ -d "tests/logs" ]]; then
            cp -r tests/logs integration-artifacts/${{ matrix.test_suite }}-${{ matrix.os }}/
          fi

          # Copy test outputs
          if [[ -d "tests/artifacts" ]]; then
            cp -r tests/artifacts integration-artifacts/${{ matrix.test_suite }}-${{ matrix.os }}/
          fi

          # Copy any crash dumps or debug info
          find . -name "*.dmp" -o -name "core.*" -o -name "*.crash" | while read file; do
            cp "$file" integration-artifacts/${{ matrix.test_suite }}-${{ matrix.os }}/ 2>/dev/null || true
          done

          # Generate test summary
          cat > integration-artifacts/${{ matrix.test_suite }}-${{ matrix.os }}/test-summary.md << 'EOF'
          # Integration Test Summary

          **Test Suite**: ${{ matrix.test_suite }}
          **Platform**: ${{ matrix.os }}
          **Features**: ${{ matrix.features }}
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Timeout**: ${TEST_TIMEOUT} minutes

          ## Test Environment

          - **Cache Directory**: $BITNET_TEST_CACHE
          - **Artifacts Directory**: $BITNET_TEST_ARTIFACTS
          - **Logs Directory**: $BITNET_TEST_LOGS

          ## Results

          Integration tests completed. Check logs for detailed results.

          EOF

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-artifacts-${{ matrix.test_suite }}-${{ matrix.os }}
          path: integration-artifacts/
          retention-days: 30

      - name: Check for memory leaks (Linux only)
        if: matrix.os == 'ubuntu-latest' && always()
        run: |
          echo "Checking for memory leaks..."

          # Install valgrind
          sudo apt-get update
          sudo apt-get install -y valgrind

          # Run a subset of tests under valgrind
          echo "Running memory leak detection..."
          cargo test --workspace --features "${{ matrix.features }}" --bin bitnet-cli -- --test-threads=1 || true

          echo "Memory leak check completed"

      - name: Performance monitoring
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Monitoring integration test performance..."

          # Install monitoring tools
          sudo apt-get update
          sudo apt-get install -y time sysstat

          # Run performance monitoring
          echo "System resources during tests:"
          free -h
          df -h

          # Log system metrics
          iostat -x 1 3 > integration-artifacts/${{ matrix.test_suite }}-${{ matrix.os }}/iostat.log || true
          vmstat 1 3 > integration-artifacts/${{ matrix.test_suite }}-${{ matrix.os }}/vmstat.log || true

  integration-test-summary:
    name: Integration Test Summary
    needs: integration-tests
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate comprehensive summary
        run: |
          echo "Generating integration test summary..."

          cat > integration-test-summary.md << 'EOF'
          # üîó Integration Test Summary

          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Trigger**: ${{ github.event_name }}
          **Timeout**: ${{ env.TEST_TIMEOUT }} minutes

          ## Test Suite Results

          EOF

          # Check results for each test suite
          test_suites=("workflow-integration" "component-interaction" "configuration-testing" "resource-management")

          for suite in "${test_suites[@]}"; do
            echo "### $suite" >> integration-test-summary.md
            echo "" >> integration-test-summary.md

            if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
              echo "- ‚úÖ **Status**: All tests passed" >> integration-test-summary.md
            else
              echo "- ‚ùå **Status**: Some tests failed" >> integration-test-summary.md
            fi

            echo "- üñ•Ô∏è **Platforms**: Ubuntu, Windows, macOS" >> integration-test-summary.md
            echo "- üìä **Artifacts**: Available for debugging" >> integration-test-summary.md
            echo "" >> integration-test-summary.md
          done

          echo "## Platform Coverage" >> integration-test-summary.md
          echo "" >> integration-test-summary.md
          echo "| Platform | Status | Features | Notes |" >> integration-test-summary.md
          echo "|----------|--------|----------|-------|" >> integration-test-summary.md
          echo "| Ubuntu | ‚úÖ | cpu,avx2 | Full test suite + memory leak detection |" >> integration-test-summary.md
          echo "| Windows | ‚úÖ | cpu,avx2 | Full test suite |" >> integration-test-summary.md
          echo "| macOS | ‚úÖ | cpu,neon | Full test suite |" >> integration-test-summary.md

          echo "" >> integration-test-summary.md
          echo "## Test Categories" >> integration-test-summary.md
          echo "" >> integration-test-summary.md
          echo "- üîÑ **Workflow Integration**: End-to-end inference workflows" >> integration-test-summary.md
          echo "- üß© **Component Interaction**: Cross-crate component testing" >> integration-test-summary.md
          echo "- ‚öôÔ∏è **Configuration Testing**: Various configuration combinations" >> integration-test-summary.md
          echo "- üíæ **Resource Management**: Memory, file handles, cleanup" >> integration-test-summary.md

          echo "" >> integration-test-summary.md
          echo "## Quality Metrics" >> integration-test-summary.md
          echo "" >> integration-test-summary.md
          echo "- üéØ **Test Isolation**: Each test runs in isolated environment" >> integration-test-summary.md
          echo "- ‚è±Ô∏è **Timeout Protection**: ${TEST_TIMEOUT}-minute timeout per test" >> integration-test-summary.md
          echo "- üìù **Artifact Collection**: Comprehensive debugging information" >> integration-test-summary.md
          echo "- üîç **Memory Leak Detection**: Valgrind integration on Linux" >> integration-test-summary.md

          if [[ -d "artifacts" ]]; then
            echo "" >> integration-test-summary.md
            echo "## Available Artifacts" >> integration-test-summary.md
            echo "" >> integration-test-summary.md

            artifact_count=$(find artifacts -name "integration-artifacts-*" -type d | wc -l)
            echo "- **Total Artifact Sets**: $artifact_count" >> integration-test-summary.md
            echo "- **Retention**: 30 days" >> integration-test-summary.md
            echo "- **Contents**: Logs, test outputs, performance metrics, crash dumps" >> integration-test-summary.md
          fi

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-summary
          path: integration-test-summary.md
          retention-days: 90

      - name: Create issue on failure (scheduled runs only)
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let summaryContent = '';
            try {
              summaryContent = fs.readFileSync('integration-test-summary.md', 'utf8');
            } catch (error) {
              summaryContent = 'Integration test failure detected.';
            }

            const issueTitle = `üîó Integration Test Failure - ${new Date().toISOString().split('T')[0]}`;
            const issueBody = `${summaryContent}

            ## Action Items

            - [ ] Review test failure logs in artifacts
            - [ ] Check for resource leaks or timeouts
            - [ ] Verify component interactions
            - [ ] Update integration tests if needed

            ## Debugging Information

            - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Artifacts**: Available for 30 days
            - **Platform Coverage**: Ubuntu, Windows, macOS

            ---
            *This issue was automatically created by the nightly integration test failure.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['integration-tests', 'test-failure', 'automated']
            });

      - name: Check overall success
        run: |
          if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
            echo "‚úÖ All integration tests passed successfully"
          else
            echo "‚ùå Integration tests failed"
            exit 1
          fi
