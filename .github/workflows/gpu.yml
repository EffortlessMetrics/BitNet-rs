name: GPU Testing

on:
  push:
    branches: [ main ]
    paths:
      - 'crates/bitnet-kernels/**'
      - 'crates/bitnet-inference/**'
      - '.github/workflows/gpu.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'crates/bitnet-kernels/**'
      - 'crates/bitnet-inference/**'
      - '.github/workflows/gpu.yml'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run GPU tests'
        required: false
        default: 'false'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-D warnings"

jobs:
  gpu-preflight:
    name: GPU Preflight Check
    runs-on: ubuntu-latest
    outputs:
      gpu_available: ${{ steps.check.outputs.gpu_available }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for GPU availability
        id: check
        run: |
          # Check if we have a GPU runner available
          if nvidia-smi &>/dev/null || [ -n "$CUDA_HOME" ]; then
            echo "gpu_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ GPU detected"
          else
            echo "gpu_available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No GPU detected - tests will be skipped"
          fi
      
      - name: Run preflight check
        run: cargo run -p xtask -- gpu-preflight --format json

  gpu-build:
    name: Build with GPU features
    runs-on: ubuntu-latest
    needs: gpu-preflight
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-gpu-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-gpu-
      
      - name: Build GPU features
        run: |
          echo "üî® Building with GPU features..."
          cargo build --workspace --no-default-features --features gpu
      
      - name: Check GPU code
        run: |
          cargo clippy --workspace --no-default-features --features gpu -- -D warnings

  gpu-smoke-test:
    name: GPU Smoke Tests
    runs-on: [self-hosted, gpu]  # Requires self-hosted GPU runner
    needs: [gpu-preflight, gpu-build]
    if: needs.gpu-preflight.outputs.gpu_available == 'true' || github.event.inputs.force_run == 'true'
    strategy:
      matrix:
        test_size: [tiny, small]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Setup CUDA (if available)
        run: |
          if command -v nvidia-smi &>/dev/null; then
            echo "CUDA is available"
            nvidia-smi
            nvcc --version || echo "nvcc not found"
          fi
      
      - name: Run GPU smoke test
        env:
          GPU_TEST_SIZE: ${{ matrix.test_size }}
          GPU_TEST_TOLERANCE: 0.99
        run: |
          cargo run -p xtask -- gpu-smoke \
            --size ${{ matrix.test_size }} \
            --tolerance 0.99
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-test-results-${{ matrix.test_size }}
          path: |
            target/test-results/
            target/gpu-metrics.json

  gpu-parity-test:
    name: CPU-GPU Parity Tests
    runs-on: [self-hosted, gpu]
    needs: [gpu-preflight, gpu-smoke-test]
    if: needs.gpu-preflight.outputs.gpu_available == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Run parity tests
        run: |
          cargo test --package bitnet-kernels \
            --test gpu_smoke \
            --no-default-features \
            --features cuda \
            -- --nocapture
      
      - name: Generate parity report
        run: |
          echo "## CPU-GPU Parity Report" > parity-report.md
          echo "" >> parity-report.md
          echo "Test completed at: $(date)" >> parity-report.md
          echo "" >> parity-report.md
          echo "### Results" >> parity-report.md
          echo "‚úÖ All parity tests passed" >> parity-report.md
      
      - name: Upload parity report
        uses: actions/upload-artifact@v4
        with:
          name: parity-report
          path: parity-report.md

  demo-gpu:
    name: Run Demos (Optional)
    runs-on: ubuntu-latest
    needs: [gpu-build]
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build demos
        run: |
          cargo build -p bitnet-tests \
            --bin demo_reporting_system \
            --bin demo_reporting_comprehensive \
            --features reporting
      
      - name: Run demos
        run: |
          cargo run -p xtask -- demo --which all

  # Summary job that always runs
  gpu-summary:
    name: GPU Test Summary
    runs-on: ubuntu-latest
    needs: [gpu-preflight, gpu-build, gpu-smoke-test, gpu-parity-test]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## GPU Test Summary"
          echo ""
          
          if [ "${{ needs.gpu-preflight.outputs.gpu_available }}" == "true" ]; then
            echo "‚úÖ GPU was available for testing"
          else
            echo "‚ö†Ô∏è No GPU available - tests were skipped"
            echo ""
            echo "GPU tests require a self-hosted runner with GPU access."
            echo "CPU-only tests have been run instead."
          fi
          
          echo ""
          echo "### Job Results"
          echo "- Preflight: ${{ needs.gpu-preflight.result }}"
          echo "- Build: ${{ needs.gpu-build.result }}"
          echo "- Smoke Test: ${{ needs.gpu-smoke-test.result }}"
          echo "- Parity Test: ${{ needs.gpu-parity-test.result }}"
      
      - name: Set status
        if: needs.gpu-build.result == 'failure'
        run: exit 1